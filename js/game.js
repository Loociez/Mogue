import{map as e,TILE_SIZE as t}from"./map.js";import{Player as o}from"./player.js";import{Projectile as a}from"./projectile.js";import{rollUpgrades as n,applyUpgrade as l,rollUberUpgrades as i}from"./upgrades.js";import{Enemy as r,spawnMiniBoss as s,spawnBoss as c}from"./enemy.js";let p,f,d,m,h=[new r(5,5,0,"normal"),new r(10,5,1,"brute"),new r(15,5,2,"shooter")],x=null;const u=document.getElementById("hp"),y=document.getElementById("xp"),g=document.getElementById("gold"),M=document.getElementById("stats");let w,b={},C={x:0,y:0},k=[],v=[],E=[],S=[],H=0,$=180,T=1,D=0,j=!1,I=!1,P=null,B=!1,L=null,A=0,F={x:0,y:0,zoom:1.5};function G(){j=!0,I=!0;const t=document.getElementById("characterSelect");t.style.display="block",t.innerHTML="";const a=document.createElement("label");a.textContent="Select Sprite Slot: ";const n=document.createElement("select");n.id="spriteSlotSelect";for(let e=0;e<32;e++){const t=document.createElement("option");t.value=e,t.textContent=`Slot ${e}`,n.appendChild(t)}n.addEventListener("change",()=>{A=parseInt(n.value)}),t.appendChild(a),t.appendChild(n),t.appendChild(document.createElement("br")),[{type:"warrior",name:"Warrior",desc:"High HP & damage"},{type:"archer",name:"Archer",desc:"Fires spread projectiles"},{type:"mage",name:"Mage",desc:"Fires homing projectiles"}].forEach(a=>{const n=document.createElement("button");n.textContent=`${a.name} - ${a.desc}`,n.onclick=()=>function(t){const[a,n]=function(t,o){if(!e)return[t,o];if(e.isWalkable(t,o))return[t,o];for(let a=1;a<=10;a++)for(let n=-a;n<=a;n++)for(let l=-a;l<=a;l++){const a=t+n,i=o+l;if(e.isWalkable(a,i))return[a,i]}return[t,o]}(11,10);w=new o(t,A),w.reset(a,n),document.getElementById("characterSelect").style.display="none",j=!1,I=!1,h=[],k=[],v=[],E=[],H=0,$=180,T=1,D=0,L=null,B=!1,x&&cancelAnimationFrame(x);x=requestAnimationFrame(O)}(a.type),t.appendChild(n)});const l=document.createElement("div");l.style.marginTop="20px",l.style.color="#fff",l.style.font="16px sans-serif",l.innerHTML="\n    <h3>Controls</h3>\n    <p>WASD / Arrow Keys - Move</p>\n    <p>Space / Tap Attack - Fire</p>\n    <p>K - Open Shop</p>\n    <p>Esc - Pause</p>\n  ",t.appendChild(l)}function R(e){const t=document.getElementById("upgradeUI"),o=document.getElementById("upgradeButtons");o.innerHTML="",e.forEach(e=>{const t=document.createElement("button");t.textContent=`${e.name}: ${e.desc}`,t.onclick=()=>function(e){e.apply?e.apply(w):l(w,e);L=null,document.getElementById("upgradeUI").style.display="none",I=!1,j=!1}(e),o.appendChild(t)}),t.style.display="block",I=!0,j=!0}function z(){L=w.level%10==0?i(w):n(w),R(L)}window.addEventListener("keydown",e=>{"Escape"!==e.key||L||(j=!j),I||(b[e.key]=!0)}),window.giveGold=(e=1e6)=>{w?(w.gold+=e,console.log(`Gave player ${e} gold! Total: ${w.gold}`),"function"==typeof updateGoldUI&&updateGoldUI()):console.warn("Player not defined yet.")};let W=!1;const X=[{name:"1) XP Boost",cost:70,action:()=>w.gainXp(10,z)},{name:"2) Spread Projectile",cost:100,action:()=>w.unlockProjectile("spread")},{name:"3) Homing Projectile",cost:150,action:()=>w.unlockProjectile("homing")},{name:"4) Heavy Projectile",cost:150,action:()=>w.unlockProjectile("heavy")},{name:"5) Speed Boost",cost:12e3,action:()=>{w.speed+=1}},{name:"6) Exploding Projectiles",cost:25e3,action:()=>{w.projectileExplosion=!0}},{name:"7) Life Leech",cost:3e4,action:()=>{w.lifeLeech=.2}},{name:"8) Critical Boost",cost:18e3,action:()=>{w.critChance=Math.min(w.critChance+.1,1),w.critMultiplier+=.5}},{name:"9) Max Range Increase",cost:15e3,action:()=>{w.maxDistance+=100}}];function O(){!function(){if(j||B)return;D++,e.updateAnimation(),D%300==0&&(T+=.5,$=Math.max(40,$-2));!I&&w.hp>0&&w.update(k,h);H++,H>=$&&(H=0,function(){if(!w)return;for(let o=0;o<8;o++){const o=Math.floor(4*Math.random());let a,n;if(0===o?(a=0,n=Math.floor(Math.random()*(m/t))):1===o?(a=Math.floor(d/t)-1,n=Math.floor(Math.random()*(m/t))):2===o?(n=0,a=Math.floor(Math.random()*(d/t))):(n=Math.floor(m/t)-1,a=Math.floor(Math.random()*(d/t))),!e.isWalkable(a,n))continue;if(Math.abs(a-w.x)+Math.abs(n-w.y)<5)continue;if(Math.random()<.02&&!h.some(e=>"boss"===e.type)){const e=["mega","storm","berserk"],t=e[Math.floor(Math.random()*e.length)];return void h.push(c(a,n,t))}if(Math.random()<.05){const e=["classic","rain","tracking"],t=e[Math.floor(Math.random()*e.length)];return void h.push(s(a,n,t))}let l="normal",i=0;const p=Math.random();p<.1?(l="brute",i=1):p<.2?(l="shooter",i=12):p<.3?(l="fast",i=3):p<.4?(l="tank",i=4):p<.5?(l="spitter",i=5):p<.6?(l="bossling",i=6):p<.7?(l="assassin",i=7):p<.8?(l="wizard",i=8):p<.9?(l="golem",i=9):(l="archer",i=10);const f=new r(a,n,i,l);switch(l){case"brute":f.maxHp=120+30*T,f.hp=f.maxHp,f.touchDamage=12+3*T,f.speed=.8;break;case"shooter":f.maxHp=80+25*T,f.hp=f.maxHp,f.touchDamage=6+2*T,f.speed=.9,f.projectileSpeed=3,f.fireCooldownMax=120,f.fireCooldown=f.fireCooldownMax;break;case"fast":f.maxHp=40+10*T,f.hp=f.maxHp,f.touchDamage=4+T,f.speed=1.8;break;case"tank":f.maxHp=150+50*T,f.hp=f.maxHp,f.touchDamage=10+2*T,f.speed=.6;break;case"spitter":f.maxHp=60+20*T,f.hp=f.maxHp,f.touchDamage=3+T,f.speed=1,f.projectileSpeed=2.5,f.fireCooldownMax=90,f.fireCooldown=f.fireCooldownMax;break;case"bossling":f.maxHp=200+50*T,f.hp=f.maxHp,f.touchDamage=15+4*T,f.speed=1,f.projectileSpeed=3,f.fireCooldownMax=100,f.fireCooldown=f.fireCooldownMax;break;case"assassin":f.maxHp=50+15*T,f.hp=f.maxHp,f.touchDamage=8+2*T,f.speed=2;break;case"wizard":f.maxHp=40+10*T,f.hp=f.maxHp,f.touchDamage=6+2*T,f.speed=1.2,f.projectileSpeed=3.5,f.fireCooldownMax=90,f.fireCooldown=f.fireCooldownMax;break;case"golem":f.maxHp=180+60*T,f.hp=f.maxHp,f.touchDamage=14+4*T,f.speed=.5;break;case"archer":f.maxHp=70+20*T,f.hp=f.maxHp,f.touchDamage=5+1.5*T,f.speed=1,f.projectileSpeed=2.8,f.fireCooldownMax=100,f.fireCooldown=f.fireCooldownMax;break;default:f.maxHp=50+15*T,f.hp=f.maxHp,f.touchDamage=5+1.5*T,f.speed=1}return f.entryDelay=30,void h.push(f)}}());for(let o=h.length-1;o>=0;o--){const n=h[o];if(n.entryDelay>0){n.entryDelay--;continue}n.update(w,D,k),e.applyTileEffects(n,Math.floor(n.px/t),Math.floor(n.py/t));if(["shooter","spitter","wizard","archer","bossling"].includes(n.type)&&n.fireCooldown<=0){const e=w.px+t/2-(n.px+t/2),o=w.py+t/2-(n.py+t/2),l=Math.hypot(e,o),i=n.projectileSpeed||3,r=e/l*i,s=o/l*i;let c="normal",p=150;switch(n.type){case"spitter":c="bouncing",p=120;break;case"wizard":c="homing",p=180;break;case"archer":c="spread",p=200;break;case"bossling":c="heavy",p=250}k.push(new a(n.px+t/2,n.py+t/2,r,s,.8*n.touchDamage,60,1,c,p)),n.fireCooldown=n.fireCooldownMax}if(n.fireCooldown>0&&n.fireCooldown--,n.hp<=0){const e=n.isMiniBoss?Math.floor(50+5*T):Math.floor(5+2*T),a=n.isMiniBoss?10+Math.floor(T/2):1+Math.floor(T/2);v.push({x:n.px+t/2,y:n.py+t/2,r:4,value:a}),w.gold+=e,h.splice(o,1)}}for(let e=k.length-1;e>=0;e--){const o=k[e];if(!(o instanceof a)){k.splice(e,1);continue}o.update(h);const n=o.x-(o.startX??o.x),l=o.y-(o.startY??o.y);if(o.maxDistance&&Math.hypot(n,l)>=o.maxDistance)k.splice(e,1);else{if(o.owner===w)for(let e=h.length-1;e>=0;e--){const a=h[e];if(U(o.x,o.y,o.radius,a.px,a.py,t,t)){let e=1.5*o.damage;const n=Math.random()<w.critChance;if(n&&(e*=2),a.hp-=e,w.healFromDamage(e),E.push({x:a.px+t/2,y:a.py,value:Math.floor(e),life:30,color:n?"#ff0":"#fff",font:n?"bold 18px sans-serif":"16px sans-serif",crit:n}),a.flashTimer=5,w.projectileExplosion){const n=60;S.push({x:o.x,y:o.y,radius:n,life:20,maxLife:20});for(const l of h){if(l===a)continue;if(Math.hypot(l.px+t/2-o.x,l.py+t/2-o.y)<=n){const o=Math.floor(.5*e);l.hp-=o,w.healFromDamage(o),E.push({x:l.px+t/2,y:l.py,value:o,life:20,color:"#f66",font:"14px sans-serif"}),l.flashTimer=5}}}if(o.pierce--,o.pierce<=0)break}}else if(o.owner!==w&&U(o.x,o.y,o.radius,w.px,w.py,t,t)){w.takeDamage(o.damage),k.splice(e,1);continue}(o.life<=0||o.pierce<=0)&&k.splice(e,1)}}for(let e=v.length-1;e>=0;e--){const o=v[e],a=w.px+t/2-o.x,n=w.py+t/2-o.y,l=Math.hypot(a,n);l<w.pickupRange&&(o.x+=a/Math.max(l,1)*3,o.y+=n/Math.max(l,1)*3),l<8&&(w.gainXp(o.value,z),w.gold+=o.value,v.splice(e,1))}for(let e=E.length-1;e>=0;e--){const t=E[e];t.y-=.5,t.life--,t.life<=0&&E.splice(e,1)}for(let e=S.length-1;e>=0;e--){const t=S[e];t.life--,t.life<=0&&S.splice(e,1)}if(w.hp<=0&&!B){B=!0,P={level:w.level,gold:w.gold,time:Math.floor(D/60)};const e=document.getElementById("deathOverlay");e.innerHTML=`\n      <h2>You Died</h2>\n      <p>Level: ${P.level}</p>\n      <p>Gold: ${P.gold}</p>\n      <p>Time: ${P.time}s</p>\n      <p><a href="https://mirageonlineclassic.com" target="_blank">Mirage Online Classic - Visit the pixel MMORPG!</a></p>\n      <button id="restartBtn">Restart</button>\n    `,e.style.display="block",document.getElementById("restartBtn").onclick=()=>{e.style.display="none",G()}}w&&(F.x=w.px+t/2-d/(2*F.zoom),F.y=w.py+t/2-m/(2*F.zoom),F.x=Math.max(0,Math.min(F.x,e.width*t-d/F.zoom)),F.y=Math.max(0,Math.min(F.y,e.height*t-m/F.zoom)));K()}(),function(){f.clearRect(0,0,d,m);let t=0,o=0,n=0;if(w.contactIFrames>0){const e=w.contactIFrames/30,a=6;t=(Math.random()-.5)*a*e,o=(Math.random()-.5)*a*e,n=.3*e}f.save(),f.translate(t,o),f.scale(F.zoom,F.zoom),f.translate(-F.x,-F.y),e.draw(f),f.save();for(const e of v)f.beginPath(),f.arc(e.x,e.y,e.r,0,2*Math.PI),f.fillStyle="#3cf",f.fill();f.restore(),h.forEach(e=>{e.isMiniBoss&&Array.isArray(e.rainTelegraph)&&e.rainTelegraph.length>0&&(f.save(),f.fillStyle="rgba(0, 255, 255, 0.4)",e.rainTelegraph.forEach(e=>{f.beginPath(),f.arc(e.x,e.y,6,0,2*Math.PI),f.fill()}),f.restore()),e.draw(f)}),w&&w.draw(f);f.save();for(const e of E)f.fillStyle=e.color||"#fff",f.font=e.font||"16px sans-serif",f.textAlign="center",f.fillText(e.value,e.x,e.y),e.crit&&(f.fillStyle="#ff0",f.font="bold 14px sans-serif",f.fillText("Crit!",e.x,e.y-16)),e.x+=e.dx||0,e.y+=e.dy||0;f.restore(),f.save();for(const e of S){const t=e.life/e.maxLife;f.beginPath(),f.arc(e.x,e.y,e.radius*(1-.5*t),0,2*Math.PI),f.fillStyle=`rgba(255, 100, 0, ${.4*t})`,f.fill(),f.strokeStyle=`rgba(255, 200, 0, ${.6*t})`,f.lineWidth=2,f.stroke()}f.restore(),f.save();for(const e of k)e instanceof a&&e.draw(f);f.restore(),f.restore(),n>0&&(f.fillStyle=`rgba(255,0,0,${n})`,f.fillRect(0,0,d,m));if(B||j&&!I){if(!j)return;j&&!I&&function(){f.fillStyle="rgba(0,0,0,0.6)",f.fillRect(0,0,d,m),f.fillStyle="#fff",f.font="28px sans-serif",f.textAlign="center",f.fillText("Game Paused",d/2,m/2-40),f.font="18px sans-serif",f.fillText(`Current Run: Lv ${w.level}, Gold ${w.gold}, Time ${(D/60).toFixed(1)}s`,d/2,m/2),P&&f.fillText(`Last Run: Lv ${P.level}, Gold ${P.gold}, Time ${P.time}s`,d/2,m/2+30);f.font="16px sans-serif",f.fillText("WASD / Arrows = Move",d/2,m/2+80),f.fillText("Space = Attack",d/2,m/2+100),f.fillText("K = Shop",d/2,m/2+120),f.fillText("Esc = Pause",d/2,m/2+140)}()}W&&W&&w&&(f.fillStyle="rgba(192,173,229,6)",f.fillRect(0,0,d,m),f.fillStyle="#fff",f.font="28px sans-serif",f.textAlign="center",f.fillText("Shop",d/2,80),f.font="20px sans-serif",X.forEach((e,t)=>{const o=140+40*t;f.fillStyle=w.gold>=e.cost?"#d6f266":"#888",f.fillText(`${e.name} - ${e.cost} Gold`,d/2,o)}),f.font="16px sans-serif",f.fillStyle="#fff",f.fillText("Press 1-9 to buy item, K to close",d/2,m-40))}(),x=requestAnimationFrame(O)}function K(){w&&(u.textContent=`HP: ${Math.ceil(w.hp)} / ${w.maxHp}`,y.textContent=`Lv ${w.level} | XP: ${w.xp} / ${w.xpToNext}`,g.textContent=`Gold: ${w.gold}`,M.textContent=`DMG ${w.damage} | ROF ${(60/w.fireCooldownMax).toFixed(1)}/s | SPD ${w.speed.toFixed(1)}`)}function U(e,t,o,a,n,l,i){const r=e-Math.max(a,Math.min(e,a+l)),s=t-Math.max(n,Math.min(t,n+i));return r*r+s*s<=o*o}window.addEventListener("keydown",e=>{if(!W||!w)return;const t=parseInt(e.key)-1;if(t>=0&&t<X.length){const e=X[t];w.gold>=e.cost&&(w.gold-=e.cost,e.action(),K(),W=!1,j=!1)}}),window.addEventListener("keydown",e=>{"k"!==e.key.toLowerCase()||I||(W=!W,j=W)}),window.addEventListener("load",function(){p=document.getElementById("gameCanvas"),f=p.getContext("2d"),d=p.width,m=p.height,e.load("maps/map.json").then(()=>G()),p.addEventListener("mousemove",e=>{const t=p.getBoundingClientRect();C.x=e.clientX-t.left,C.y=e.clientY-t.top}),p.addEventListener("click",()=>{B&&G()})});