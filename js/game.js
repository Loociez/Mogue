import{map as e,TILE_SIZE as t}from"./map.js";import{Player as o}from"./player.js";import{Projectile as n}from"./projectile.js";import{Enemy as l,spawnMiniBoss as a,spawnBoss as i}from"./enemy.js";import{skillTree as s,resetSkillTree as r}from"./skilltree.js";import{applyAllSkills as c,unlockSkill as d,createClusterProjectile as p,applyExplodingShot as f}from"./skills.js";let m,h,y,u,x=[new l(5,5,0,"normal"),new l(10,5,1,"brute"),new l(15,5,2,"shooter")],g=null;const k=document.getElementById("hp"),b=document.getElementById("xp"),v=document.getElementById("gold"),w=document.getElementById("stats");let M,C={},E={x:0,y:0},T=[],S=[],P=[],L=[],H=0,I=180,j=1,B=0,D=!1,$=!1,A=null,R=!1,F=!1,G=0,z={x:0,y:0,zoom:1.5};function U(){let e=document.getElementById("skillTreeUI");if(!e){e=document.createElement("div"),e.id="skillTreeUI",e.style.position="fixed",e.style.inset="0",e.style.display="none",e.style.background="rgba(0,0,0,0.7)",e.style.zIndex=1e3,e.style.padding="24px",e.style.overflow="auto",e.style.font="16px sans-serif";const t=document.createElement("div");t.id="skillTreePanel",t.style.maxWidth="1000px",t.style.margin="0 auto",t.style.background="#14161a",t.style.border="2px solid #6cf",t.style.borderRadius="12px",t.style.padding="16px";const o=document.createElement("div");o.style.display="flex",o.style.justifyContent="space-between",o.style.alignItems="center";const n=document.createElement("h2");n.textContent="Skill Tree",n.style.color="#fff",n.style.margin="0 0 8px 0";const l=document.createElement("div");l.id="skillPointsLabel",l.style.color="#d6f266",l.textContent="Points: 0",o.appendChild(n),o.appendChild(l);const a=document.createElement("div");a.id="skillGrid",a.style.display="flex",a.style.flexDirection="row",a.style.gap="24px",a.style.justifyContent="space-around";const i=document.createElement("div");i.style.display="flex",i.style.justifyContent="flex-end",i.style.marginTop="12px";const s=document.createElement("button");s.textContent="Close (L)",s.onclick=K,W(s),i.appendChild(s),t.appendChild(o),t.appendChild(a),t.appendChild(i),e.appendChild(t),document.body.appendChild(e)}}function W(e){e.style.padding="8px 10px",e.style.borderRadius="8px",e.style.border="1px solid #6cf",e.style.background="#0e1116",e.style.color="#fff",e.style.cursor="pointer"}function q(){const e=document.getElementById("skillGrid"),t=document.getElementById("skillPointsLabel");if(!e||!t||!M)return;e.innerHTML="",t.textContent=`Points: ${M.skillPoints||0}`,e.style.position="relative";const o={left:[],middle:[],right:[]},n={};if(Array.isArray(s.root)&&s.root.length>0&&o.middle.push(s.root[0]),s.nodes&&"object"==typeof s.nodes)for(const e in s.nodes){const t=s.nodes[e];Array.isArray(t)&&t.forEach(e=>{if(!e||!e.id)return;const t=e.branch&&o[e.branch]?e.branch:"middle";null==e.level&&(e.level=0),null==e.maxLevel&&(e.id.startsWith("uber_")?e.maxLevel=3:e.id.startsWith("ultimate_")?e.maxLevel=1:e.maxLevel=5),o[t].push(e)})}let l=document.getElementById("skillTreeSVG");l||(l=document.createElementNS("http://www.w3.org/2000/svg","svg"),l.id="skillTreeSVG",l.style.position="absolute",l.style.top="0",l.style.left="0",l.style.width="100%",l.style.height="100%",l.style.pointerEvents="none",e.appendChild(l)),l.innerHTML="";["left","middle","right"].forEach(t=>{const l=document.createElement("div");l.style.display="flex",l.style.flexDirection="column",l.style.alignItems="center",l.style.flex="1",l.style.gap="16px";o[t].forEach((e,t)=>{if(!e||!e.id)return;const o=document.createElement("div");o.style.border="1px solid #2d3947",o.style.borderRadius="10px",o.style.padding="10px",o.style.background="#0e1116",o.style.textAlign="center",o.style.width="200px";let a=e.level<e.maxLevel&&M.skillPoints>0;if(e.requires){const t=O(e.requires);t&&0!==t.level||(a=!1)}a||(o.style.opacity="0.4");const i=document.createElement("div");i.textContent=e.name||e.id,i.style.fontWeight="bold",i.style.color=1===e.maxLevel?"#ff66ff":3===e.maxLevel?"#ff4444":"#ffff66";const s=document.createElement("div");s.textContent=`Level: ${e.level}/${e.maxLevel}`,s.style.color="#d6f266",s.style.margin="4px 0";const r=document.createElement("div");r.textContent=e.desc||"",r.style.color="#b8c0cc",r.style.margin="6px 0";const c=document.createElement("button");c.textContent=e.level>=e.maxLevel?"Maxed":"Upgrade",W(c),c.disabled=!a,c.onclick=()=>{let t=e.level<e.maxLevel&&M.skillPoints>0;if(e.requires){const o=O(e.requires);o&&0!==o.level||(t=!1)}t&&(e.level++,M.skillPoints--,"function"==typeof e.apply&&e.apply(M,e.level),q(),Q())},o.appendChild(i),o.appendChild(s),o.appendChild(r),o.appendChild(c),l.appendChild(o),n[e.id]={x:0,y:0,card:o}}),e.appendChild(l)});Object.values(n).forEach(t=>{const o=t.card.getBoundingClientRect(),n=e.getBoundingClientRect();t.x=o.left-n.left+o.width/2,t.y=o.top-n.top+o.height/2});for(const e in s.nodes){const t=s.nodes[e];if(!Array.isArray(t))continue;const o=n[e];o&&t.forEach(e=>{const t=n[e.id];if(!t)return;const a=O(e.id)?.requires;let i=!0;if(a){const e=O(a);e&&0!==e.level||(i=!1)}const s=document.createElementNS("http://www.w3.org/2000/svg","line");s.setAttribute("x1",o.x),s.setAttribute("y1",o.y+60),s.setAttribute("x2",t.x),s.setAttribute("y2",t.y-60),s.setAttribute("stroke",i?"#6cf":"#666"),s.setAttribute("stroke-width","2"),l.appendChild(s)})}}function O(e){let t=s.root.find(t=>t.id===e);if(t)return t;for(const o in s.nodes)if(t=s.nodes[o].find(t=>t.id===e),t)return t;return null}function X(){if(!M)return;U(),q();document.getElementById("skillTreeUI").style.display="block",F=!0,$=!0,D=!0}function K(){const e=document.getElementById("skillTreeUI");e&&(e.style.display="none"),F=!1,$=!1,D=!1}function N(){D=!0,$=!0;const t=document.getElementById("characterSelect");t.style.display="block",t.innerHTML="";const n=document.createElement("canvas");n.width=64,n.height=64,n.style.border="2px solid #fff",n.style.marginBottom="10px",t.appendChild(n);const l=n.getContext("2d"),a=new Image;function i(e){const t=12*e+3,o=a.naturalWidth/32||32,i=t%o*32,s=32*Math.floor(t/o);l.clearRect(0,0,n.width,n.height),a.complete&&l.drawImage(a,i,s,32,32,0,0,n.width,n.height)}a.src="assets/player.png",a.onload=()=>i(G);const s=document.createElement("label");s.textContent="Select Sprite Slot: ";const d=document.createElement("select");d.id="spriteSlotSelect";for(let e=0;e<32;e++){const t=document.createElement("option");t.value=e,t.textContent=`Slot ${e}`,d.appendChild(t)}d.addEventListener("change",()=>{G=parseInt(d.value),i(G)}),t.appendChild(s),t.appendChild(d),t.appendChild(document.createElement("br")),[{type:"warrior",name:"Warrior",desc:"High HP & damage"},{type:"archer",name:"Archer",desc:"Fires spread projectiles"},{type:"mage",name:"Mage",desc:"Fires homing projectiles"}].forEach(n=>{const l=document.createElement("button");l.textContent=`${n.name} - ${n.desc}`,l.onclick=()=>function(t){const[n,l]=function(t,o){if(!e)return[t,o];if(e.isWalkable(t,o))return[t,o];for(let n=1;n<=10;n++)for(let l=-n;l<=n;l++)for(let a=-n;a<=n;a++){const n=t+l,i=o+a;if(e.isWalkable(n,i))return[n,i]}return[t,o]}(11,10);M=new o(t,G),M.reset(n,l),r(),c(M),document.getElementById("characterSelect").style.display="none",D=!1,$=!1,x=[],T=[],S=[],P=[],H=0,I=180,j=1,B=0,R=!1,g&&cancelAnimationFrame(g);g=requestAnimationFrame(J)}(n.type),t.appendChild(l)});const p=document.createElement("div");p.style.marginTop="20px",p.style.color="#fff",p.style.font="16px sans-serif",p.innerHTML="\n    <h3>Controls</h3>\n    <p>WASD / Arrow Keys - Move</p>\n    <p>Space / Tap Attack - Fire</p>\n    <p>K - Open Shop</p>\n    <p>L - Skill Tree</p>\n    <p>Shift - Blink - Unlockable</p>\n    <p>Esc - Pause</p>\n  ",t.appendChild(p)}window.addEventListener("keydown",o=>{if("Escape"!==o.key||$||(D=!D),$||(C[o.key]=!0),"l"===o.key.toLowerCase()&&(F?K():V||R||X()),"Shift"===o.key&&M&&M.unlockedSkills.includes("blink")&&(!M.blinkCooldownTimer||M.blinkCooldownTimer<=0)){const o=M.px,n=M.py,l=M.blinkDistance||150,a=E.x/z.zoom+z.x-(M.px+t/2),i=E.y/z.zoom+z.y-(M.py+t/2),s=Math.hypot(a,i),r=s>l?l/s:1;M.px+=a*r,M.py+=i*r,M.px=Math.max(0,Math.min(M.px,e.width*t-t)),M.py=Math.max(0,Math.min(M.py,e.height*t-t)),"function"==typeof M.createBlinkTrail&&M.createBlinkTrail(o,n,M.px,M.py),M.blinkCooldownTimer=M.blinkCooldown||180}}),window.giveGold=(e=1e6)=>{M?(M.gold+=e,console.log(`Gave player ${e} gold! Total: ${M.gold}`),"function"==typeof updateGoldUI&&updateGoldUI()):console.warn("Player not defined yet.")},window.setMaxHP=(e=9999999)=>{M?(M.hp=e,M.maxHp=e,console.log(`Player HP set to ${e}`),"function"==typeof updateHpUI&&updateHpUI()):console.warn("Player not defined yet.")},window.setLevel=(e=40)=>{M?(M.level=e,console.log(`Player level set to ${e}`),M.exp=0,"function"==typeof updateLevelUI&&updateLevelUI()):console.warn("Player not defined yet.")};let V=!1;const Y=[{name:"1) XP Boost",cost:70,action:()=>M.gainXp(10,_)},{name:"2) Spread Projectile",cost:100,action:()=>M.unlockProjectile("spread")},{name:"3) Homing Projectile",cost:150,action:()=>M.unlockProjectile("homing")},{name:"4) Heavy Projectile",cost:150,action:()=>M.unlockProjectile("heavy")},{name:"5) Speed Boost",cost:12e3,action:()=>{M.speed+=1}},{name:"6) Exploding Projectiles",cost:250,action:()=>{M.projectileExplosion=!0}},{name:"7) Life Leech",cost:3e4,action:()=>{M.lifeLeech=.2}},{name:"8) Critical Boost",cost:18e3,action:()=>{M.critChance=Math.min((M.critChance||0)+.1,1),M.critMultiplier=(M.critMultiplier||1.5)+.5}},{name:"9) Max Range Increase",cost:150,action:()=>{M.maxDistance+=100}}];function _(){M&&(M.skillPoints=(M.skillPoints||0)+1,X())}function J(){!function(){if(D||R)return;M.blinkCooldownTimer>0&&(M.blinkCooldownTimer-=1,M.blinkCooldownTimer<0&&(M.blinkCooldownTimer=0));B++,e.updateAnimation(),B%300==0&&(j+=.5,I=Math.max(40,I-2));!$&&M.hp>0&&M.update(T,x);H++,H>=I&&(H=0,function(){if(!M)return;for(let o=0;o<8;o++){const o=Math.floor(4*Math.random());let n,s;if(0===o?(n=0,s=Math.floor(Math.random()*(u/t))):1===o?(n=Math.floor(y/t)-1,s=Math.floor(Math.random()*(u/t))):2===o?(s=0,n=Math.floor(Math.random()*(y/t))):(s=Math.floor(u/t)-1,n=Math.floor(Math.random()*(y/t))),!e.isWalkable(n,s))continue;if(Math.abs(n-M.x)+Math.abs(s-M.y)<5)continue;if(M.level>=40&&Math.random()<.02&&!x.some(e=>"lateBoss"===e.type)){const e=new l(n,s,15,"lateBoss");return e.maxHp=1e3+50*j,e.hp=e.maxHp,e.touchDamage=25+5*j,e.speed=1.5,e.specialAttackCooldown=180,e.entryDelay=60,e.isLateBoss=!0,void x.push(e)}if(Math.random()<.02&&!x.some(e=>"boss"===e.type)){const e=["mega","storm","berserk"],t=e[Math.floor(Math.random()*e.length)],o=18;return void x.push(i(n,s,t,!1,o))}if(Math.random()<.04){const e=["classic","rain","tracking"],t=e[Math.floor(Math.random()*e.length)],o=20;return void x.push(a(n,s,t,o))}let r="normal",c=0;const d=Math.random();d<.1?(r="brute",c=5):d<.2?(r="shooter",c=8):d<.3?(r="fast",c=50):d<.4?(r="tank",c=4):d<.5?(r="spitter",c=10):d<.6?(r="bossling",c=6):d<.7?(r="assassin",c=7):d<.8?(r="wizard",c=25):d<.9?(r="golem",c=3):(r="archer",c=21);const p=new l(n,s,c,r);switch(r){case"assassin":p.aiType="ambusher";break;case"shooter":p.aiType="ranged-kiter";break;default:p.aiType=r}switch(r){case"brute":p.maxHp=120+30*j,p.hp=p.maxHp,p.touchDamage=12+3*j,p.speed=.8;break;case"shooter":p.maxHp=80+25*j,p.hp=p.maxHp,p.touchDamage=6+2*j,p.speed=.9,p.projectileSpeed=3,p.fireCooldownMax=120,p.fireCooldown=0,p.fireProjectile=!0;break;case"fast":p.maxHp=40+10*j,p.hp=p.maxHp,p.touchDamage=4+j,p.speed=1.8;break;case"tank":p.maxHp=150+50*j,p.hp=p.maxHp,p.touchDamage=10+2*j,p.speed=.6;break;case"spitter":p.maxHp=60+20*j,p.hp=p.maxHp,p.touchDamage=3+j,p.speed=1,p.projectileSpeed=2.5,p.fireCooldownMax=90,p.fireCooldown=0,p.fireProjectile=!0;break;case"bossling":p.maxHp=200+50*j,p.hp=p.maxHp,p.touchDamage=15+4*j,p.speed=1,p.projectileSpeed=3,p.fireCooldownMax=100,p.fireCooldown=0,p.fireProjectile=!0;break;case"assassin":p.maxHp=50+15*j,p.hp=p.maxHp,p.touchDamage=8+2*j,p.speed=2;break;case"wizard":p.maxHp=40+10*j,p.hp=p.maxHp,p.touchDamage=6+2*j,p.speed=1.2,p.projectileSpeed=3.5,p.fireCooldownMax=90,p.fireCooldown=0,p.fireProjectile=!0;break;case"golem":p.maxHp=180+60*j,p.hp=p.maxHp,p.touchDamage=14+4*j,p.speed=.5;break;case"archer":p.maxHp=70+20*j,p.hp=p.maxHp,p.touchDamage=5+1.5*j,p.speed=1,p.projectileSpeed=2.8,p.fireCooldownMax=100,p.fireCooldown=0,p.fireProjectile=!0;break;default:p.maxHp=50+15*j,p.hp=p.maxHp,p.touchDamage=5+1.5*j,p.speed=1}return p.entryDelay=30,void x.push(p)}}());for(let o=x.length-1;o>=0;o--){const l=x[o];if(l.entryDelay>0){l.entryDelay--;continue}l.update(M,B,T),e.applyTileEffects(l,Math.floor(l.px/t),Math.floor(l.py/t));if(["shooter","spitter","wizard","archer","bossling"].includes(l.type)&&l.fireCooldown<=0){const e=M.px+t/2-(l.px+t/2),o=M.py+t/2-(l.py+t/2),a=Math.hypot(e,o),i=l.projectileSpeed||3,s=e/a*i,r=o/a*i;let c="normal",d=150;switch(l.type){case"spitter":c="bouncing",d=120;break;case"wizard":c="homing",d=180;break;case"archer":c="spread",d=200;break;case"bossling":c="heavy",d=250}T.push(new n(l.px+t/2,l.py+t/2,s,r,.8*l.touchDamage,60,1,c,d)),l.fireCooldown=l.fireCooldownMax}if(l.hp<=0){const e=l.isMiniBoss?Math.floor(50+5*j):Math.floor(5+2*j),n=l.isMiniBoss?10+Math.floor(j/2):1+Math.floor(j/2);S.push({x:l.px+t/2,y:l.py+t/2,r:4,value:n}),M.gold+=e,x.splice(o,1)}}for(let e=T.length-1;e>=0;e--){const o=T[e];if(!(o instanceof n)){T.splice(e,1);continue}o.update(x);const l=o.x-(o.startX??o.x),a=o.y-(o.startY??o.y);if(o.maxDistance&&Math.hypot(l,a)>=o.maxDistance)T.splice(e,1);else{if(o.owner===M)for(let e=x.length-1;e>=0;e--){const n=x[e];if(Z(o.x,o.y,o.radius,n.px,n.py,t,t)){let e=1.5*o.damage;const l=Math.random()<(M.critChance||0);if(l&&(e*=2),n.hp-=e,"function"==typeof M.healFromDamage&&M.healFromDamage(e),P.push({x:n.px+t/2,y:n.py,value:Math.floor(e),life:30,color:l?"#ff0":"#fff",font:l?"bold 18px sans-serif":"16px sans-serif",crit:l}),n.flashTimer=5,M.projectileExplosion){const l=60;L.push({x:o.x,y:o.y,radius:l,life:20,maxLife:20});for(const a of x){if(a===n)continue;if(Math.hypot(a.px+t/2-o.x,a.py+t/2-o.y)<=l){const o=Math.floor(.5*e);a.hp-=o,"function"==typeof M.healFromDamage&&M.healFromDamage(o),P.push({x:a.px+t/2,y:a.py,value:o,life:20,color:"#f66",font:"14px sans-serif"}),a.flashTimer=5}}}if(o.pierce--,o.pierce<=0)break}}else if(o.owner!==M&&Z(o.x,o.y,o.radius,M.px,M.py,t,t)){"function"==typeof M.takeDamage&&M.takeDamage(o.damage),T.splice(e,1);continue}(o.life<=0||o.pierce<=0)&&T.splice(e,1)}}for(let e=S.length-1;e>=0;e--){const o=S[e],n=M.px+t/2-o.x,l=M.py+t/2-o.y,a=Math.hypot(n,l);a<M.pickupRange&&(o.x+=n/Math.max(a,1)*3,o.y+=l/Math.max(a,1)*3),a<8&&(M.gainXp(o.value,_),M.gold+=o.value,S.splice(e,1))}for(let e=P.length-1;e>=0;e--){const t=P[e];t.y-=.5,t.life--,t.life<=0&&P.splice(e,1)}for(let e=L.length-1;e>=0;e--){const t=L[e];t.life--,t.life<=0&&L.splice(e,1)}if(M.hp<=0&&!R){R=!0,A={level:M.level,gold:M.gold,time:Math.floor(B/60)};const e=document.getElementById("deathOverlay");e.innerHTML=`\n      <h2>You Died</h2>\n      <p>Level: ${A.level}</p>\n      <p>Gold: ${A.gold}</p>\n      <p>Time: ${A.time}s</p>\n      <p><a href="https://mirageonlineclassic.com" target="_blank">Mirage Online Classic - Visit the pixel MMORPG!</a></p>\n      <button id="restartBtn">Restart</button>\n    `,e.style.display="block",document.getElementById("restartBtn").onclick=()=>{e.style.display="none",N()}}M&&(z.x=M.px+t/2-y/(2*z.zoom),z.y=M.py+t/2-u/(2*z.zoom),z.x=Math.max(0,Math.min(z.x,e.width*t-y/z.zoom)),z.y=Math.max(0,Math.min(z.y,e.height*t-u/z.zoom)));Q()}(),function(){h.clearRect(0,0,y,u);let t=0,o=0,l=0;if(M.contactIFrames>0){const e=M.contactIFrames/30,n=6;t=(Math.random()-.5)*n*e,o=(Math.random()-.5)*n*e,l=.3*e}h.save(),h.translate(t,o),h.scale(z.zoom,z.zoom),h.translate(-z.x,-z.y),e.draw(h),h.save();for(const e of S)h.beginPath(),h.arc(e.x,e.y,e.r,0,2*Math.PI),h.fillStyle="#3cf",h.fill();h.restore(),x.forEach(e=>{e.isMiniBoss&&Array.isArray(e.rainTelegraph)&&e.rainTelegraph.length>0&&(h.save(),h.fillStyle="rgba(0, 255, 255, 0.4)",e.rainTelegraph.forEach(e=>{h.beginPath(),h.arc(e.x,e.y,6,0,2*Math.PI),h.fill()}),h.restore()),e.draw(h)}),M&&M.draw(h);h.save();for(const e of P)h.fillStyle=e.color||"#fff",h.font=e.font||"16px sans-serif",h.textAlign="center",h.fillText(e.value,e.x,e.y),e.crit&&(h.fillStyle="#ff0",h.font="bold 14px sans-serif",h.fillText("Crit!",e.x,e.y-16)),e.x+=e.dx||0,e.y+=e.dy||0;h.restore(),h.save();for(const e of L){const t=e.life/e.maxLife;h.beginPath(),h.arc(e.x,e.y,e.radius*(1-.5*t),0,2*Math.PI),h.fillStyle=`rgba(255, 100, 0, ${.4*t})`,h.fill(),h.strokeStyle=`rgba(255, 200, 0, ${.6*t})`,h.lineWidth=2,h.stroke()}h.restore(),h.save();for(const e of T)e instanceof n&&e.draw(h);h.restore(),h.restore(),l>0&&(h.fillStyle=`rgba(255,0,0,${l})`,h.fillRect(0,0,y,u));if(R||D&&!$){if(!D)return;D&&!$&&function(){h.fillStyle="rgba(0,0,0,0.6)",h.fillRect(0,0,y,u),h.fillStyle="#fff",h.font="28px sans-serif",h.textAlign="center",h.fillText("Game Paused",y/2,u/2-40),h.font="18px sans-serif",h.fillText(`Current Run: Lv ${M.level}, Gold ${M.gold}, Time ${(B/60).toFixed(1)}s`,y/2,u/2),A&&h.fillText(`Last Run: Lv ${A.level}, Gold ${A.gold}, Time ${A.time}s`,y/2,u/2+30);h.font="16px sans-serif",h.fillText("WASD / Arrows = Move",y/2,u/2+80),h.fillText("Space = Attack",y/2,u/2+100),h.fillText("K = Shop",y/2,u/2+120),h.fillText("L = Skill Tree, <Shift> = Blink",y/2,u/2+140),h.fillText("Esc = Pause",y/2,u/2+160)}()}V&&V&&M&&(h.fillStyle="rgba(192,173,229,0.6)",h.fillRect(0,0,y,u),h.fillStyle="#fff",h.font="28px sans-serif",h.textAlign="center",h.fillText("Shop",y/2,80),h.font="20px sans-serif",Y.forEach((e,t)=>{const o=140+40*t;h.fillStyle=M.gold>=e.cost?"#d6f266":"#888",h.fillText(`${e.name} - ${e.cost} Gold`,y/2,o)}),h.font="16px sans-serif",h.fillStyle="#fff",h.fillText("Press 1-9 to buy item, K to close",y/2,u-40))}(),g=requestAnimationFrame(J)}function Q(){M&&(k.textContent=`HP: ${Math.ceil(M.hp)} / ${M.maxHp}`,b.textContent=`Lv ${M.level} | XP: ${M.xp} / ${M.xpToNext} | SP ${M.skillPoints||0}`,v.textContent=`Gold: ${M.gold}`,w.textContent=`DMG ${M.damage} | ROF ${(60/M.fireCooldownMax).toFixed(1)}/s | SPD ${M.speed.toFixed(1)}`)}function Z(e,t,o,n,l,a,i){const s=e-Math.max(n,Math.min(e,n+a)),r=t-Math.max(l,Math.min(t,l+i));return s*s+r*r<=o*o}window.addEventListener("keydown",e=>{if(!V||!M)return;const t=parseInt(e.key)-1;if(t>=0&&t<Y.length){const e=Y[t];M.gold>=e.cost&&(M.gold-=e.cost,e.action(),Q(),V=!1,D=!1,$=!1)}}),window.addEventListener("keydown",e=>{"k"===e.key.toLowerCase()&&(V?(V=!1,D=!1,$=!1):$||(V=!0,D=!0,$=!0))}),window.addEventListener("load",()=>{m=document.getElementById("gameCanvas"),h=m.getContext("2d"),y=m.width,u=m.height,e.load("maps/map.json").then(()=>N()),m.addEventListener("mousemove",e=>{const t=m.getBoundingClientRect();E.x=e.clientX-t.left,E.y=e.clientY-t.top}),m.addEventListener("click",()=>{R&&N()}),U()});