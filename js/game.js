import{map as e,TILE_SIZE as t}from"./map.js";import{Player as o}from"./player.js";import{Projectile as n}from"./projectile.js";import{Enemy as l,spawnMiniBoss as a,spawnBoss as i}from"./enemy.js";import{skillTree as s}from"./skilltree.js";import{applyAllSkills as r,unlockSkill as c,createClusterProjectile as d,applyExplodingShot as p}from"./skills.js";let f,m,h,y,u=[new l(5,5,0,"normal"),new l(10,5,1,"brute"),new l(15,5,2,"shooter")],x=null;const g=document.getElementById("hp"),k=document.getElementById("xp"),b=document.getElementById("gold"),v=document.getElementById("stats");let w,M={},C={x:0,y:0},E=[],T=[],S=[],P=[],L=0,H=180,I=1,j=0,B=!1,D=!1,$=null,A=!1,R=!1,F=0,G={x:0,y:0,zoom:1.5};function z(){let e=document.getElementById("skillTreeUI");if(!e){e=document.createElement("div"),e.id="skillTreeUI",e.style.position="fixed",e.style.inset="0",e.style.display="none",e.style.background="rgba(0,0,0,0.7)",e.style.zIndex=1e3,e.style.padding="24px",e.style.overflow="auto",e.style.font="16px sans-serif";const t=document.createElement("div");t.id="skillTreePanel",t.style.maxWidth="1000px",t.style.margin="0 auto",t.style.background="#14161a",t.style.border="2px solid #6cf",t.style.borderRadius="12px",t.style.padding="16px";const o=document.createElement("div");o.style.display="flex",o.style.justifyContent="space-between",o.style.alignItems="center";const n=document.createElement("h2");n.textContent="Skill Tree",n.style.color="#fff",n.style.margin="0 0 8px 0";const l=document.createElement("div");l.id="skillPointsLabel",l.style.color="#d6f266",l.textContent="Points: 0",o.appendChild(n),o.appendChild(l);const a=document.createElement("div");a.id="skillGrid",a.style.display="flex",a.style.flexDirection="row",a.style.gap="24px",a.style.justifyContent="space-around";const i=document.createElement("div");i.style.display="flex",i.style.justifyContent="flex-end",i.style.marginTop="12px";const s=document.createElement("button");s.textContent="Close (L)",s.onclick=X,U(s),i.appendChild(s),t.appendChild(o),t.appendChild(a),t.appendChild(i),e.appendChild(t),document.body.appendChild(e)}}function U(e){e.style.padding="8px 10px",e.style.borderRadius="8px",e.style.border="1px solid #6cf",e.style.background="#0e1116",e.style.color="#fff",e.style.cursor="pointer"}function W(){const e=document.getElementById("skillGrid"),t=document.getElementById("skillPointsLabel");if(!e||!t||!w)return;e.innerHTML="",t.textContent=`Points: ${w.skillPoints||0}`,e.style.position="relative";const o={left:[],middle:[],right:[]},n={};if(Array.isArray(s.root)&&s.root.length>0&&o.middle.push(s.root[0]),s.nodes&&"object"==typeof s.nodes)for(const e in s.nodes){const t=s.nodes[e];Array.isArray(t)&&t.forEach(e=>{if(!e||!e.id)return;const t=e.branch&&o[e.branch]?e.branch:"middle";null==e.level&&(e.level=0),null==e.maxLevel&&(e.id.startsWith("uber_")?e.maxLevel=3:e.id.startsWith("ultimate_")?e.maxLevel=1:e.maxLevel=5),o[t].push(e)})}let l=document.getElementById("skillTreeSVG");l||(l=document.createElementNS("http://www.w3.org/2000/svg","svg"),l.id="skillTreeSVG",l.style.position="absolute",l.style.top="0",l.style.left="0",l.style.width="100%",l.style.height="100%",l.style.pointerEvents="none",e.appendChild(l)),l.innerHTML="";["left","middle","right"].forEach(t=>{const l=document.createElement("div");l.style.display="flex",l.style.flexDirection="column",l.style.alignItems="center",l.style.flex="1",l.style.gap="16px";o[t].forEach((e,t)=>{if(!e||!e.id)return;const o=document.createElement("div");o.style.border="1px solid #2d3947",o.style.borderRadius="10px",o.style.padding="10px",o.style.background="#0e1116",o.style.textAlign="center",o.style.width="200px";let a=e.level<e.maxLevel&&w.skillPoints>0;if(e.requires){const t=q(e.requires);t&&0!==t.level||(a=!1)}a||(o.style.opacity="0.4");const i=document.createElement("div");i.textContent=e.name||e.id,i.style.fontWeight="bold",i.style.color=1===e.maxLevel?"#ff66ff":3===e.maxLevel?"#ff4444":"#ffff66";const s=document.createElement("div");s.textContent=`Level: ${e.level}/${e.maxLevel}`,s.style.color="#d6f266",s.style.margin="4px 0";const r=document.createElement("div");r.textContent=e.desc||"",r.style.color="#b8c0cc",r.style.margin="6px 0";const c=document.createElement("button");c.textContent=e.level>=e.maxLevel?"Maxed":"Upgrade",U(c),c.disabled=!a,c.onclick=()=>{let t=e.level<e.maxLevel&&w.skillPoints>0;if(e.requires){const o=q(e.requires);o&&0!==o.level||(t=!1)}t&&(e.level++,w.skillPoints--,"function"==typeof e.apply&&e.apply(w,e.level),W(),J())},o.appendChild(i),o.appendChild(s),o.appendChild(r),o.appendChild(c),l.appendChild(o),n[e.id]={x:0,y:0,card:o}}),e.appendChild(l)});Object.values(n).forEach(t=>{const o=t.card.getBoundingClientRect(),n=e.getBoundingClientRect();t.x=o.left-n.left+o.width/2,t.y=o.top-n.top+o.height/2});for(const e in s.nodes){const t=s.nodes[e];if(!Array.isArray(t))continue;const o=n[e];o&&t.forEach(e=>{const t=n[e.id];if(!t)return;const a=q(e.id)?.requires;let i=!0;if(a){const e=q(a);e&&0!==e.level||(i=!1)}const s=document.createElementNS("http://www.w3.org/2000/svg","line");s.setAttribute("x1",o.x),s.setAttribute("y1",o.y+60),s.setAttribute("x2",t.x),s.setAttribute("y2",t.y-60),s.setAttribute("stroke",i?"#6cf":"#666"),s.setAttribute("stroke-width","2"),l.appendChild(s)})}}function q(e){let t=s.root.find(t=>t.id===e);if(t)return t;for(const o in s.nodes)if(t=s.nodes[o].find(t=>t.id===e),t)return t;return null}function O(){if(!w)return;z(),W();document.getElementById("skillTreeUI").style.display="block",R=!0,D=!0,B=!0}function X(){const e=document.getElementById("skillTreeUI");e&&(e.style.display="none"),R=!1,D=!1,B=!1}function K(){B=!0,D=!0;const t=document.getElementById("characterSelect");t.style.display="block",t.innerHTML="";const n=document.createElement("canvas");n.width=64,n.height=64,n.style.border="2px solid #fff",n.style.marginBottom="10px",t.appendChild(n);const l=n.getContext("2d"),a=new Image;function i(e){const t=12*e+3,o=a.naturalWidth/32||32,i=t%o*32,s=32*Math.floor(t/o);l.clearRect(0,0,n.width,n.height),a.complete&&l.drawImage(a,i,s,32,32,0,0,n.width,n.height)}a.src="assets/player.png",a.onload=()=>i(F);const s=document.createElement("label");s.textContent="Select Sprite Slot: ";const r=document.createElement("select");r.id="spriteSlotSelect";for(let e=0;e<32;e++){const t=document.createElement("option");t.value=e,t.textContent=`Slot ${e}`,r.appendChild(t)}r.addEventListener("change",()=>{F=parseInt(r.value),i(F)}),t.appendChild(s),t.appendChild(r),t.appendChild(document.createElement("br")),[{type:"warrior",name:"Warrior",desc:"High HP & damage"},{type:"archer",name:"Archer",desc:"Fires spread projectiles"},{type:"mage",name:"Mage",desc:"Fires homing projectiles"}].forEach(n=>{const l=document.createElement("button");l.textContent=`${n.name} - ${n.desc}`,l.onclick=()=>function(t){const[n,l]=function(t,o){if(!e)return[t,o];if(e.isWalkable(t,o))return[t,o];for(let n=1;n<=10;n++)for(let l=-n;l<=n;l++)for(let a=-n;a<=n;a++){const n=t+l,i=o+a;if(e.isWalkable(n,i))return[n,i]}return[t,o]}(11,10);w=new o(t,F),w.reset(n,l),"number"!=typeof w.skillPoints&&(w.skillPoints=0);Array.isArray(w.unlockedSkills)||(w.unlockedSkills=[]);document.getElementById("characterSelect").style.display="none",B=!1,D=!1,u=[],E=[],T=[],S=[],L=0,H=180,I=1,j=0,A=!1,x&&cancelAnimationFrame(x);x=requestAnimationFrame(_)}(n.type),t.appendChild(l)});const c=document.createElement("div");c.style.marginTop="20px",c.style.color="#fff",c.style.font="16px sans-serif",c.innerHTML="\n    <h3>Controls</h3>\n    <p>WASD / Arrow Keys - Move</p>\n    <p>Space / Tap Attack - Fire</p>\n    <p>K - Open Shop</p>\n    <p>L - Skill Tree</p>\n    <p>Shift - Blink - Unlockable</p>\n    <p>Esc - Pause</p>\n  ",t.appendChild(c)}window.addEventListener("keydown",o=>{if("Escape"!==o.key||D||(B=!B),D||(M[o.key]=!0),"l"===o.key.toLowerCase()&&(R?X():N||A||O()),"Shift"===o.key&&w&&w.unlockedSkills.includes("blink")&&(!w.blinkCooldownTimer||w.blinkCooldownTimer<=0)){const o=w.px,n=w.py,l=w.blinkDistance||150,a=C.x/G.zoom+G.x-(w.px+t/2),i=C.y/G.zoom+G.y-(w.py+t/2),s=Math.hypot(a,i),r=s>l?l/s:1;w.px+=a*r,w.py+=i*r,w.px=Math.max(0,Math.min(w.px,e.width*t-t)),w.py=Math.max(0,Math.min(w.py,e.height*t-t)),"function"==typeof w.createBlinkTrail&&w.createBlinkTrail(o,n,w.px,w.py),w.blinkCooldownTimer=w.blinkCooldown||180}}),window.giveGold=(e=1e6)=>{w?(w.gold+=e,console.log(`Gave player ${e} gold! Total: ${w.gold}`),"function"==typeof updateGoldUI&&updateGoldUI()):console.warn("Player not defined yet.")},window.setMaxHP=(e=9999999)=>{w?(w.hp=e,w.maxHp=e,console.log(`Player HP set to ${e}`),"function"==typeof updateHpUI&&updateHpUI()):console.warn("Player not defined yet.")},window.setLevel=(e=40)=>{w?(w.level=e,console.log(`Player level set to ${e}`),w.exp=0,"function"==typeof updateLevelUI&&updateLevelUI()):console.warn("Player not defined yet.")};let N=!1;const V=[{name:"1) XP Boost",cost:70,action:()=>w.gainXp(10,Y)},{name:"2) Spread Projectile",cost:100,action:()=>w.unlockProjectile("spread")},{name:"3) Homing Projectile",cost:150,action:()=>w.unlockProjectile("homing")},{name:"4) Heavy Projectile",cost:150,action:()=>w.unlockProjectile("heavy")},{name:"5) Speed Boost",cost:12e3,action:()=>{w.speed+=1}},{name:"6) Exploding Projectiles",cost:250,action:()=>{w.projectileExplosion=!0}},{name:"7) Life Leech",cost:3e4,action:()=>{w.lifeLeech=.2}},{name:"8) Critical Boost",cost:18e3,action:()=>{w.critChance=Math.min((w.critChance||0)+.1,1),w.critMultiplier=(w.critMultiplier||1.5)+.5}},{name:"9) Max Range Increase",cost:150,action:()=>{w.maxDistance+=100}}];function Y(){w&&(w.skillPoints=(w.skillPoints||0)+1,O())}function _(){!function(){if(B||A)return;w.blinkCooldownTimer>0&&(w.blinkCooldownTimer-=1,w.blinkCooldownTimer<0&&(w.blinkCooldownTimer=0));j++,e.updateAnimation(),j%300==0&&(I+=.5,H=Math.max(40,H-2));!D&&w.hp>0&&w.update(E,u);L++,L>=H&&(L=0,function(){if(!w)return;for(let o=0;o<8;o++){const o=Math.floor(4*Math.random());let n,s;if(0===o?(n=0,s=Math.floor(Math.random()*(y/t))):1===o?(n=Math.floor(h/t)-1,s=Math.floor(Math.random()*(y/t))):2===o?(s=0,n=Math.floor(Math.random()*(h/t))):(s=Math.floor(y/t)-1,n=Math.floor(Math.random()*(h/t))),!e.isWalkable(n,s))continue;if(Math.abs(n-w.x)+Math.abs(s-w.y)<5)continue;if(w.level>=40&&Math.random()<.02&&!u.some(e=>"lateBoss"===e.type)){const e=new l(n,s,15,"lateBoss");return e.maxHp=1e3+50*I,e.hp=e.maxHp,e.touchDamage=25+5*I,e.speed=1.5,e.specialAttackCooldown=180,e.entryDelay=60,e.isLateBoss=!0,void u.push(e)}if(Math.random()<.02&&!u.some(e=>"boss"===e.type)){const e=["mega","storm","berserk"],t=e[Math.floor(Math.random()*e.length)],o=18;return void u.push(i(n,s,t,!1,o))}if(Math.random()<.04){const e=["classic","rain","tracking"],t=e[Math.floor(Math.random()*e.length)],o=20;return void u.push(a(n,s,t,o))}let r="normal",c=0;const d=Math.random();d<.1?(r="brute",c=5):d<.2?(r="shooter",c=8):d<.3?(r="fast",c=50):d<.4?(r="tank",c=4):d<.5?(r="spitter",c=10):d<.6?(r="bossling",c=6):d<.7?(r="assassin",c=7):d<.8?(r="wizard",c=25):d<.9?(r="golem",c=3):(r="archer",c=21);const p=new l(n,s,c,r);switch(r){case"assassin":p.aiType="ambusher";break;case"shooter":p.aiType="ranged-kiter";break;default:p.aiType=r}switch(r){case"brute":p.maxHp=120+30*I,p.hp=p.maxHp,p.touchDamage=12+3*I,p.speed=.8;break;case"shooter":p.maxHp=80+25*I,p.hp=p.maxHp,p.touchDamage=6+2*I,p.speed=.9,p.projectileSpeed=3,p.fireCooldownMax=120,p.fireCooldown=0,p.fireProjectile=!0;break;case"fast":p.maxHp=40+10*I,p.hp=p.maxHp,p.touchDamage=4+I,p.speed=1.8;break;case"tank":p.maxHp=150+50*I,p.hp=p.maxHp,p.touchDamage=10+2*I,p.speed=.6;break;case"spitter":p.maxHp=60+20*I,p.hp=p.maxHp,p.touchDamage=3+I,p.speed=1,p.projectileSpeed=2.5,p.fireCooldownMax=90,p.fireCooldown=0,p.fireProjectile=!0;break;case"bossling":p.maxHp=200+50*I,p.hp=p.maxHp,p.touchDamage=15+4*I,p.speed=1,p.projectileSpeed=3,p.fireCooldownMax=100,p.fireCooldown=0,p.fireProjectile=!0;break;case"assassin":p.maxHp=50+15*I,p.hp=p.maxHp,p.touchDamage=8+2*I,p.speed=2;break;case"wizard":p.maxHp=40+10*I,p.hp=p.maxHp,p.touchDamage=6+2*I,p.speed=1.2,p.projectileSpeed=3.5,p.fireCooldownMax=90,p.fireCooldown=0,p.fireProjectile=!0;break;case"golem":p.maxHp=180+60*I,p.hp=p.maxHp,p.touchDamage=14+4*I,p.speed=.5;break;case"archer":p.maxHp=70+20*I,p.hp=p.maxHp,p.touchDamage=5+1.5*I,p.speed=1,p.projectileSpeed=2.8,p.fireCooldownMax=100,p.fireCooldown=0,p.fireProjectile=!0;break;default:p.maxHp=50+15*I,p.hp=p.maxHp,p.touchDamage=5+1.5*I,p.speed=1}return p.entryDelay=30,void u.push(p)}}());for(let o=u.length-1;o>=0;o--){const l=u[o];if(l.entryDelay>0){l.entryDelay--;continue}l.update(w,j,E),e.applyTileEffects(l,Math.floor(l.px/t),Math.floor(l.py/t));if(["shooter","spitter","wizard","archer","bossling"].includes(l.type)&&l.fireCooldown<=0){const e=w.px+t/2-(l.px+t/2),o=w.py+t/2-(l.py+t/2),a=Math.hypot(e,o),i=l.projectileSpeed||3,s=e/a*i,r=o/a*i;let c="normal",d=150;switch(l.type){case"spitter":c="bouncing",d=120;break;case"wizard":c="homing",d=180;break;case"archer":c="spread",d=200;break;case"bossling":c="heavy",d=250}E.push(new n(l.px+t/2,l.py+t/2,s,r,.8*l.touchDamage,60,1,c,d)),l.fireCooldown=l.fireCooldownMax}if(l.hp<=0){const e=l.isMiniBoss?Math.floor(50+5*I):Math.floor(5+2*I),n=l.isMiniBoss?10+Math.floor(I/2):1+Math.floor(I/2);T.push({x:l.px+t/2,y:l.py+t/2,r:4,value:n}),w.gold+=e,u.splice(o,1)}}for(let e=E.length-1;e>=0;e--){const o=E[e];if(!(o instanceof n)){E.splice(e,1);continue}o.update(u);const l=o.x-(o.startX??o.x),a=o.y-(o.startY??o.y);if(o.maxDistance&&Math.hypot(l,a)>=o.maxDistance)E.splice(e,1);else{if(o.owner===w)for(let e=u.length-1;e>=0;e--){const n=u[e];if(Q(o.x,o.y,o.radius,n.px,n.py,t,t)){let e=1.5*o.damage;const l=Math.random()<(w.critChance||0);if(l&&(e*=2),n.hp-=e,"function"==typeof w.healFromDamage&&w.healFromDamage(e),S.push({x:n.px+t/2,y:n.py,value:Math.floor(e),life:30,color:l?"#ff0":"#fff",font:l?"bold 18px sans-serif":"16px sans-serif",crit:l}),n.flashTimer=5,w.projectileExplosion){const l=60;P.push({x:o.x,y:o.y,radius:l,life:20,maxLife:20});for(const a of u){if(a===n)continue;if(Math.hypot(a.px+t/2-o.x,a.py+t/2-o.y)<=l){const o=Math.floor(.5*e);a.hp-=o,"function"==typeof w.healFromDamage&&w.healFromDamage(o),S.push({x:a.px+t/2,y:a.py,value:o,life:20,color:"#f66",font:"14px sans-serif"}),a.flashTimer=5}}}if(o.pierce--,o.pierce<=0)break}}else if(o.owner!==w&&Q(o.x,o.y,o.radius,w.px,w.py,t,t)){"function"==typeof w.takeDamage&&w.takeDamage(o.damage),E.splice(e,1);continue}(o.life<=0||o.pierce<=0)&&E.splice(e,1)}}for(let e=T.length-1;e>=0;e--){const o=T[e],n=w.px+t/2-o.x,l=w.py+t/2-o.y,a=Math.hypot(n,l);a<w.pickupRange&&(o.x+=n/Math.max(a,1)*3,o.y+=l/Math.max(a,1)*3),a<8&&(w.gainXp(o.value,Y),w.gold+=o.value,T.splice(e,1))}for(let e=S.length-1;e>=0;e--){const t=S[e];t.y-=.5,t.life--,t.life<=0&&S.splice(e,1)}for(let e=P.length-1;e>=0;e--){const t=P[e];t.life--,t.life<=0&&P.splice(e,1)}if(w.hp<=0&&!A){A=!0,$={level:w.level,gold:w.gold,time:Math.floor(j/60)};const e=document.getElementById("deathOverlay");e.innerHTML=`\n      <h2>You Died</h2>\n      <p>Level: ${$.level}</p>\n      <p>Gold: ${$.gold}</p>\n      <p>Time: ${$.time}s</p>\n      <p><a href="https://mirageonlineclassic.com" target="_blank">Mirage Online Classic - Visit the pixel MMORPG!</a></p>\n      <button id="restartBtn">Restart</button>\n    `,e.style.display="block",document.getElementById("restartBtn").onclick=()=>{e.style.display="none",K()}}w&&(G.x=w.px+t/2-h/(2*G.zoom),G.y=w.py+t/2-y/(2*G.zoom),G.x=Math.max(0,Math.min(G.x,e.width*t-h/G.zoom)),G.y=Math.max(0,Math.min(G.y,e.height*t-y/G.zoom)));J()}(),function(){m.clearRect(0,0,h,y);let t=0,o=0,l=0;if(w.contactIFrames>0){const e=w.contactIFrames/30,n=6;t=(Math.random()-.5)*n*e,o=(Math.random()-.5)*n*e,l=.3*e}m.save(),m.translate(t,o),m.scale(G.zoom,G.zoom),m.translate(-G.x,-G.y),e.draw(m),m.save();for(const e of T)m.beginPath(),m.arc(e.x,e.y,e.r,0,2*Math.PI),m.fillStyle="#3cf",m.fill();m.restore(),u.forEach(e=>{e.isMiniBoss&&Array.isArray(e.rainTelegraph)&&e.rainTelegraph.length>0&&(m.save(),m.fillStyle="rgba(0, 255, 255, 0.4)",e.rainTelegraph.forEach(e=>{m.beginPath(),m.arc(e.x,e.y,6,0,2*Math.PI),m.fill()}),m.restore()),e.draw(m)}),w&&w.draw(m);m.save();for(const e of S)m.fillStyle=e.color||"#fff",m.font=e.font||"16px sans-serif",m.textAlign="center",m.fillText(e.value,e.x,e.y),e.crit&&(m.fillStyle="#ff0",m.font="bold 14px sans-serif",m.fillText("Crit!",e.x,e.y-16)),e.x+=e.dx||0,e.y+=e.dy||0;m.restore(),m.save();for(const e of P){const t=e.life/e.maxLife;m.beginPath(),m.arc(e.x,e.y,e.radius*(1-.5*t),0,2*Math.PI),m.fillStyle=`rgba(255, 100, 0, ${.4*t})`,m.fill(),m.strokeStyle=`rgba(255, 200, 0, ${.6*t})`,m.lineWidth=2,m.stroke()}m.restore(),m.save();for(const e of E)e instanceof n&&e.draw(m);m.restore(),m.restore(),l>0&&(m.fillStyle=`rgba(255,0,0,${l})`,m.fillRect(0,0,h,y));if(A||B&&!D){if(!B)return;B&&!D&&function(){m.fillStyle="rgba(0,0,0,0.6)",m.fillRect(0,0,h,y),m.fillStyle="#fff",m.font="28px sans-serif",m.textAlign="center",m.fillText("Game Paused",h/2,y/2-40),m.font="18px sans-serif",m.fillText(`Current Run: Lv ${w.level}, Gold ${w.gold}, Time ${(j/60).toFixed(1)}s`,h/2,y/2),$&&m.fillText(`Last Run: Lv ${$.level}, Gold ${$.gold}, Time ${$.time}s`,h/2,y/2+30);m.font="16px sans-serif",m.fillText("WASD / Arrows = Move",h/2,y/2+80),m.fillText("Space = Attack",h/2,y/2+100),m.fillText("K = Shop",h/2,y/2+120),m.fillText("L = Skill Tree, <Shift> = Blink",h/2,y/2+140),m.fillText("Esc = Pause",h/2,y/2+160)}()}N&&N&&w&&(m.fillStyle="rgba(192,173,229,0.6)",m.fillRect(0,0,h,y),m.fillStyle="#fff",m.font="28px sans-serif",m.textAlign="center",m.fillText("Shop",h/2,80),m.font="20px sans-serif",V.forEach((e,t)=>{const o=140+40*t;m.fillStyle=w.gold>=e.cost?"#d6f266":"#888",m.fillText(`${e.name} - ${e.cost} Gold`,h/2,o)}),m.font="16px sans-serif",m.fillStyle="#fff",m.fillText("Press 1-9 to buy item, K to close",h/2,y-40))}(),x=requestAnimationFrame(_)}function J(){w&&(g.textContent=`HP: ${Math.ceil(w.hp)} / ${w.maxHp}`,k.textContent=`Lv ${w.level} | XP: ${w.xp} / ${w.xpToNext} | SP ${w.skillPoints||0}`,b.textContent=`Gold: ${w.gold}`,v.textContent=`DMG ${w.damage} | ROF ${(60/w.fireCooldownMax).toFixed(1)}/s | SPD ${w.speed.toFixed(1)}`)}function Q(e,t,o,n,l,a,i){const s=e-Math.max(n,Math.min(e,n+a)),r=t-Math.max(l,Math.min(t,l+i));return s*s+r*r<=o*o}window.addEventListener("keydown",e=>{if(!N||!w)return;const t=parseInt(e.key)-1;if(t>=0&&t<V.length){const e=V[t];w.gold>=e.cost&&(w.gold-=e.cost,e.action(),J(),N=!1,B=!1,D=!1)}}),window.addEventListener("keydown",e=>{"k"===e.key.toLowerCase()&&(N?(N=!1,B=!1,D=!1):D||(N=!0,B=!0,D=!0))}),window.addEventListener("load",()=>{f=document.getElementById("gameCanvas"),m=f.getContext("2d"),h=f.width,y=f.height,e.load("maps/map.json").then(()=>K()),f.addEventListener("mousemove",e=>{const t=f.getBoundingClientRect();C.x=e.clientX-t.left,C.y=e.clientY-t.top}),f.addEventListener("click",()=>{A&&K()}),z()});