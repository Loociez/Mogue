import{map as e,TILE_SIZE as t}from"./map.js";import{Player as o}from"./player.js";import{Projectile as a}from"./projectile.js";import{rollUpgrades as n,applyUpgrade as l,rollUberUpgrades as i}from"./upgrades.js";import{Enemy as r,spawnMiniBoss as s,spawnBoss as c}from"./enemy.js";let p,d,f,m,h=[new r(5,5,0,"normal"),new r(10,5,1,"brute"),new r(15,5,2,"shooter")],u=null;const x=document.getElementById("hp"),y=document.getElementById("xp"),g=document.getElementById("gold"),M=document.getElementById("stats");let w,b={},v={x:0,y:0},k=[],C=[],E=[],H=[],S=0,P=180,T=1,$=0,I=!1,j=!1,D=null,B=!1,L=null,A=0,F={x:0,y:0,zoom:1.5};function R(){I=!0,j=!0;const t=document.getElementById("characterSelect");t.style.display="block",t.innerHTML="";const a=document.createElement("canvas");a.width=64,a.height=64,a.style.border="2px solid #fff",a.style.marginBottom="10px",t.appendChild(a);const n=a.getContext("2d"),l=new Image;function i(e){const t=12*e+3,o=l.naturalWidth/32||32,i=t%o*32,r=32*Math.floor(t/o);n.clearRect(0,0,a.width,a.height),l.complete&&n.drawImage(l,i,r,32,32,0,0,a.width,a.height)}l.src="assets/player.png",l.onload=()=>i(A);const r=document.createElement("label");r.textContent="Select Sprite Slot: ";const s=document.createElement("select");s.id="spriteSlotSelect";for(let e=0;e<32;e++){const t=document.createElement("option");t.value=e,t.textContent=`Slot ${e}`,s.appendChild(t)}s.addEventListener("change",()=>{A=parseInt(s.value),i(A)}),t.appendChild(r),t.appendChild(s),t.appendChild(document.createElement("br")),[{type:"warrior",name:"Warrior",desc:"High HP & damage"},{type:"archer",name:"Archer",desc:"Fires spread projectiles"},{type:"mage",name:"Mage",desc:"Fires homing projectiles"}].forEach(a=>{const n=document.createElement("button");n.textContent=`${a.name} - ${a.desc}`,n.onclick=()=>function(t){const[a,n]=function(t,o){if(!e)return[t,o];if(e.isWalkable(t,o))return[t,o];for(let a=1;a<=10;a++)for(let n=-a;n<=a;n++)for(let l=-a;l<=a;l++){const a=t+n,i=o+l;if(e.isWalkable(a,i))return[a,i]}return[t,o]}(11,10);w=new o(t,A),w.reset(a,n),document.getElementById("characterSelect").style.display="none",I=!1,j=!1,h=[],k=[],C=[],E=[],S=0,P=180,T=1,$=0,L=null,B=!1,u&&cancelAnimationFrame(u);u=requestAnimationFrame(X)}(a.type),t.appendChild(n)});const c=document.createElement("div");c.style.marginTop="20px",c.style.color="#fff",c.style.font="16px sans-serif",c.innerHTML="\n    <h3>Controls</h3>\n    <p>WASD / Arrow Keys - Move</p>\n    <p>Space / Tap Attack - Fire</p>\n    <p>K - Open Shop</p>\n    <p>Esc - Pause</p>\n  ",t.appendChild(c)}function G(e){const t=document.getElementById("upgradeUI"),o=document.getElementById("upgradeButtons");o.innerHTML="",e.forEach(e=>{const t=document.createElement("button");t.textContent=`${e.name}: ${e.desc}`,t.onclick=()=>function(e){e.apply?e.apply(w):l(w,e);L=null,document.getElementById("upgradeUI").style.display="none",j=!1,I=!1}(e),o.appendChild(t)}),t.style.display="block",j=!0,I=!0}function z(){L=w.level%10==0?i(w):n(w),G(L)}window.addEventListener("keydown",e=>{"Escape"!==e.key||L||(I=!I),j||(b[e.key]=!0)}),window.giveGold=(e=1e6)=>{w?(w.gold+=e,console.log(`Gave player ${e} gold! Total: ${w.gold}`),"function"==typeof updateGoldUI&&updateGoldUI()):console.warn("Player not defined yet.")},window.setMaxHP=(e=9999999)=>{w?(w.hp=e,w.maxHp=e,console.log(`Player HP set to ${e}`),"function"==typeof updateHpUI&&updateHpUI()):console.warn("Player not defined yet.")},window.setLevel=(e=40)=>{w?(w.level=e,console.log(`Player level set to ${e}`),w.exp=0,"function"==typeof updateLevelUI&&updateLevelUI()):console.warn("Player not defined yet.")};let U=!1;const W=[{name:"1) XP Boost",cost:70,action:()=>w.gainXp(10,z)},{name:"2) Spread Projectile",cost:100,action:()=>w.unlockProjectile("spread")},{name:"3) Homing Projectile",cost:150,action:()=>w.unlockProjectile("homing")},{name:"4) Heavy Projectile",cost:150,action:()=>w.unlockProjectile("heavy")},{name:"5) Speed Boost",cost:12e3,action:()=>{w.speed+=1}},{name:"6) Exploding Projectiles",cost:250,action:()=>{w.projectileExplosion=!0}},{name:"7) Life Leech",cost:3e4,action:()=>{w.lifeLeech=.2}},{name:"8) Critical Boost",cost:18e3,action:()=>{w.critChance=Math.min(w.critChance+.1,1),w.critMultiplier+=.5}},{name:"9) Max Range Increase",cost:150,action:()=>{w.maxDistance+=100}}];function X(){!function(){if(I||B)return;$++,e.updateAnimation(),$%300==0&&(T+=.5,P=Math.max(40,P-2));!j&&w.hp>0&&w.update(k,h);S++,S>=P&&(S=0,function(){if(!w)return;for(let o=0;o<8;o++){const o=Math.floor(4*Math.random());let a,n;if(0===o?(a=0,n=Math.floor(Math.random()*(m/t))):1===o?(a=Math.floor(f/t)-1,n=Math.floor(Math.random()*(m/t))):2===o?(n=0,a=Math.floor(Math.random()*(f/t))):(n=Math.floor(m/t)-1,a=Math.floor(Math.random()*(f/t))),!e.isWalkable(a,n))continue;if(Math.abs(a-w.x)+Math.abs(n-w.y)<5)continue;if(w.level>=40&&Math.random()<.02&&!h.some(e=>"lateBoss"===e.type)){const e=new r(a,n,15,"lateBoss");return e.maxHp=1e3+50*T,e.hp=e.maxHp,e.touchDamage=25+5*T,e.speed=1.5,e.specialAttackCooldown=180,e.entryDelay=60,e.isLateBoss=!0,void h.push(e)}if(Math.random()<.02&&!h.some(e=>"boss"===e.type)){const e=["mega","storm","berserk"],t=e[Math.floor(Math.random()*e.length)],o=18;return void h.push(c(a,n,t,!1,o))}if(Math.random()<.04){const e=["classic","rain","tracking"],t=e[Math.floor(Math.random()*e.length)],o=20;return void h.push(s(a,n,t,o))}let l="normal",i=0;const p=Math.random();p<.1?(l="brute",i=5):p<.2?(l="shooter",i=8):p<.3?(l="fast",i=50):p<.4?(l="tank",i=4):p<.5?(l="spitter",i=10):p<.6?(l="bossling",i=6):p<.7?(l="assassin",i=7):p<.8?(l="wizard",i=25):p<.9?(l="golem",i=3):(l="archer",i=21);const d=new r(a,n,i,l);switch(l){case"assassin":d.aiType="ambusher";break;case"shooter":d.aiType="ranged-kiter";break;default:d.aiType=l}switch(l){case"brute":d.maxHp=120+30*T,d.hp=d.maxHp,d.touchDamage=12+3*T,d.speed=.8;break;case"shooter":d.maxHp=80+25*T,d.hp=d.maxHp,d.touchDamage=6+2*T,d.speed=.9,d.projectileSpeed=3,d.fireCooldownMax=120,d.fireCooldown=0,d.fireProjectile=!0;break;case"fast":d.maxHp=40+10*T,d.hp=d.maxHp,d.touchDamage=4+T,d.speed=1.8;break;case"tank":d.maxHp=150+50*T,d.hp=d.maxHp,d.touchDamage=10+2*T,d.speed=.6;break;case"spitter":d.maxHp=60+20*T,d.hp=d.maxHp,d.touchDamage=3+T,d.speed=1,d.projectileSpeed=2.5,d.fireCooldownMax=90,d.fireCooldown=0,d.fireProjectile=!0;break;case"bossling":d.maxHp=200+50*T,d.hp=d.maxHp,d.touchDamage=15+4*T,d.speed=1,d.projectileSpeed=3,d.fireCooldownMax=100,d.fireCooldown=0,d.fireProjectile=!0;break;case"assassin":d.maxHp=50+15*T,d.hp=d.maxHp,d.touchDamage=8+2*T,d.speed=2;break;case"wizard":d.maxHp=40+10*T,d.hp=d.maxHp,d.touchDamage=6+2*T,d.speed=1.2,d.projectileSpeed=3.5,d.fireCooldownMax=90,d.fireCooldown=0,d.fireProjectile=!0;break;case"golem":d.maxHp=180+60*T,d.hp=d.maxHp,d.touchDamage=14+4*T,d.speed=.5;break;case"archer":d.maxHp=70+20*T,d.hp=d.maxHp,d.touchDamage=5+1.5*T,d.speed=1,d.projectileSpeed=2.8,d.fireCooldownMax=100,d.fireCooldown=0,d.fireProjectile=!0;break;default:d.maxHp=50+15*T,d.hp=d.maxHp,d.touchDamage=5+1.5*T,d.speed=1}return d.entryDelay=30,void h.push(d)}}());for(let o=h.length-1;o>=0;o--){const n=h[o];if(n.entryDelay>0){n.entryDelay--;continue}n.update(w,$,k),e.applyTileEffects(n,Math.floor(n.px/t),Math.floor(n.py/t));if(["shooter","spitter","wizard","archer","bossling"].includes(n.type)&&n.fireCooldown<=0){const e=w.px+t/2-(n.px+t/2),o=w.py+t/2-(n.py+t/2),l=Math.hypot(e,o),i=n.projectileSpeed||3,r=e/l*i,s=o/l*i;let c="normal",p=150;switch(n.type){case"spitter":c="bouncing",p=120;break;case"wizard":c="homing",p=180;break;case"archer":c="spread",p=200;break;case"bossling":c="heavy",p=250}k.push(new a(n.px+t/2,n.py+t/2,r,s,.8*n.touchDamage,60,1,c,p)),n.fireCooldown=n.fireCooldownMax}if(n.hp<=0){const e=n.isMiniBoss?Math.floor(50+5*T):Math.floor(5+2*T),a=n.isMiniBoss?10+Math.floor(T/2):1+Math.floor(T/2);C.push({x:n.px+t/2,y:n.py+t/2,r:4,value:a}),w.gold+=e,h.splice(o,1)}}for(let e=k.length-1;e>=0;e--){const o=k[e];if(!(o instanceof a)){k.splice(e,1);continue}o.update(h);const n=o.x-(o.startX??o.x),l=o.y-(o.startY??o.y);if(o.maxDistance&&Math.hypot(n,l)>=o.maxDistance)k.splice(e,1);else{if(o.owner===w)for(let e=h.length-1;e>=0;e--){const a=h[e];if(K(o.x,o.y,o.radius,a.px,a.py,t,t)){let e=1.5*o.damage;const n=Math.random()<w.critChance;if(n&&(e*=2),a.hp-=e,w.healFromDamage(e),E.push({x:a.px+t/2,y:a.py,value:Math.floor(e),life:10,color:n?"#ff0":"#fff",font:n?"bold 18px sans-serif":"16px sans-serif",crit:n}),a.flashTimer=5,w.projectileExplosion){const n=60;H.push({x:o.x,y:o.y,radius:n,life:20,maxLife:20});for(const l of h){if(l===a)continue;if(Math.hypot(l.px+t/2-o.x,l.py+t/2-o.y)<=n){const o=Math.floor(.5*e);l.hp-=o,w.healFromDamage(o),E.push({x:l.px+t/2,y:l.py,value:o,life:20,color:"#f66",font:"14px sans-serif"}),l.flashTimer=5}}}if(o.pierce--,o.pierce<=0)break}}else if(o.owner!==w&&K(o.x,o.y,o.radius,w.px,w.py,t,t)){w.takeDamage(o.damage),k.splice(e,1);continue}(o.life<=0||o.pierce<=0)&&k.splice(e,1)}}for(let e=C.length-1;e>=0;e--){const o=C[e],a=w.px+t/2-o.x,n=w.py+t/2-o.y,l=Math.hypot(a,n);l<w.pickupRange&&(o.x+=a/Math.max(l,1)*3,o.y+=n/Math.max(l,1)*3),l<8&&(w.gainXp(o.value,z),w.gold+=o.value,C.splice(e,1))}for(let e=E.length-1;e>=0;e--){const t=E[e];t.y-=.5,t.life--,t.life<=0&&E.splice(e,1)}for(let e=H.length-1;e>=0;e--){const t=H[e];t.life--,t.life<=0&&H.splice(e,1)}if(w.hp<=0&&!B){B=!0,D={level:w.level,gold:w.gold,time:Math.floor($/60)};const e=document.getElementById("deathOverlay");e.innerHTML=`\n      <h2>You Died</h2>\n      <p>Level: ${D.level}</p>\n      <p>Gold: ${D.gold}</p>\n      <p>Time: ${D.time}s</p>\n      <p><a href="https://mirageonlineclassic.com" target="_blank">Mirage Online Classic - Visit the pixel MMORPG!</a></p>\n      <button id="restartBtn">Restart</button>\n    `,e.style.display="block",document.getElementById("restartBtn").onclick=()=>{e.style.display="none",R()}}w&&(F.x=w.px+t/2-f/(2*F.zoom),F.y=w.py+t/2-m/(2*F.zoom),F.x=Math.max(0,Math.min(F.x,e.width*t-f/F.zoom)),F.y=Math.max(0,Math.min(F.y,e.height*t-m/F.zoom)));O()}(),function(){d.clearRect(0,0,f,m);let t=0,o=0,n=0;if(w.contactIFrames>0){const e=w.contactIFrames/30,a=6;t=(Math.random()-.5)*a*e,o=(Math.random()-.5)*a*e,n=.3*e}d.save(),d.translate(t,o),d.scale(F.zoom,F.zoom),d.translate(-F.x,-F.y),e.draw(d),d.save();for(const e of C)d.beginPath(),d.arc(e.x,e.y,e.r,0,2*Math.PI),d.fillStyle="#3cf",d.fill();d.restore(),h.forEach(e=>{e.isMiniBoss&&Array.isArray(e.rainTelegraph)&&e.rainTelegraph.length>0&&(d.save(),d.fillStyle="rgba(0, 255, 255, 0.4)",e.rainTelegraph.forEach(e=>{d.beginPath(),d.arc(e.x,e.y,6,0,2*Math.PI),d.fill()}),d.restore()),e.draw(d)}),w&&w.draw(d);d.save();for(const e of E)d.fillStyle=e.color||"#fff",d.font=e.font||"16px sans-serif",d.textAlign="center",d.fillText(e.value,e.x,e.y),e.crit&&(d.fillStyle="#ff0",d.font="bold 14px sans-serif",d.fillText("Crit!",e.x,e.y-16)),e.x+=e.dx||0,e.y+=e.dy||0;d.restore(),d.save();for(const e of H){const t=e.life/e.maxLife;d.beginPath(),d.arc(e.x,e.y,e.radius*(1-.5*t),0,2*Math.PI),d.fillStyle=`rgba(255, 100, 0, ${.4*t})`,d.fill(),d.strokeStyle=`rgba(255, 200, 0, ${.6*t})`,d.lineWidth=2,d.stroke()}d.restore(),d.save();for(const e of k)e instanceof a&&e.draw(d);d.restore(),d.restore(),n>0&&(d.fillStyle=`rgba(255,0,0,${n})`,d.fillRect(0,0,f,m));if(B||I&&!j){if(!I)return;I&&!j&&function(){d.fillStyle="rgba(0,0,0,0.6)",d.fillRect(0,0,f,m),d.fillStyle="#fff",d.font="28px sans-serif",d.textAlign="center",d.fillText("Game Paused",f/2,m/2-40),d.font="18px sans-serif",d.fillText(`Current Run: Lv ${w.level}, Gold ${w.gold}, Time ${($/60).toFixed(1)}s`,f/2,m/2),D&&d.fillText(`Last Run: Lv ${D.level}, Gold ${D.gold}, Time ${D.time}s`,f/2,m/2+30);d.font="16px sans-serif",d.fillText("WASD / Arrows = Move",f/2,m/2+80),d.fillText("Space = Attack",f/2,m/2+100),d.fillText("K = Shop",f/2,m/2+120),d.fillText("Esc = Pause",f/2,m/2+140)}()}U&&U&&w&&(d.fillStyle="rgba(192,173,229,6)",d.fillRect(0,0,f,m),d.fillStyle="#fff",d.font="28px sans-serif",d.textAlign="center",d.fillText("Shop",f/2,80),d.font="20px sans-serif",W.forEach((e,t)=>{const o=140+40*t;d.fillStyle=w.gold>=e.cost?"#d6f266":"#888",d.fillText(`${e.name} - ${e.cost} Gold`,f/2,o)}),d.font="16px sans-serif",d.fillStyle="#fff",d.fillText("Press 1-9 to buy item, K to close",f/2,m-40))}(),u=requestAnimationFrame(X)}function O(){w&&(x.textContent=`HP: ${Math.ceil(w.hp)} / ${w.maxHp}`,y.textContent=`Lv ${w.level} | XP: ${w.xp} / ${w.xpToNext}`,g.textContent=`Gold: ${w.gold}`,M.textContent=`DMG ${w.damage} | ROF ${(60/w.fireCooldownMax).toFixed(1)}/s | SPD ${w.speed.toFixed(1)}`)}function K(e,t,o,a,n,l,i){const r=e-Math.max(a,Math.min(e,a+l)),s=t-Math.max(n,Math.min(t,n+i));return r*r+s*s<=o*o}window.addEventListener("keydown",e=>{if(!U||!w)return;const t=parseInt(e.key)-1;if(t>=0&&t<W.length){const e=W[t];w.gold>=e.cost&&(w.gold-=e.cost,e.action(),O(),U=!1,I=!1)}}),window.addEventListener("keydown",e=>{"k"!==e.key.toLowerCase()||j||(U=!U,I=U)}),window.addEventListener("load",function(){p=document.getElementById("gameCanvas"),d=p.getContext("2d"),f=p.width,m=p.height,e.load("maps/map.json").then(()=>R()),p.addEventListener("mousemove",e=>{const t=p.getBoundingClientRect();v.x=e.clientX-t.left,v.y=e.clientY-t.top}),p.addEventListener("click",()=>{B&&R()})});