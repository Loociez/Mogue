import{map as e,TILE_SIZE as t}from"./map.js";import{Player as o}from"./player.js";import{Projectile as n}from"./projectile.js";import{Enemy as l,spawnMiniBoss as a,spawnBoss as i}from"./enemy.js";import{skillTree as r,resetSkillTree as s}from"./skilltree.js";import{applyAllSkills as c,unlockSkill as d,createClusterProjectile as p,applyExplodingShot as f}from"./skills.js";let m,h,y,u,x=[new l(5,5,0,"normal"),new l(10,5,1,"brute"),new l(15,5,2,"shooter")],g=null;const M=document.getElementById("hp"),b=document.getElementById("xp"),k=document.getElementById("gold"),v=document.getElementById("stats");let w,C={},E={x:0,y:0},T=[],S=[],P=[],L=[],D=0,H=180,I=1,j=0,B=!1,$=!1,A=null,R=!1,F=0,G=!1,z=0,W={x:0,y:0,zoom:1.5},U=[];const q=new Image;q.src="assets/effects1.png";const O=32;function X(){let e=document.getElementById("skillTreeUI");if(!e){e=document.createElement("div"),e.id="skillTreeUI",e.style.position="fixed",e.style.inset="0",e.style.display="none",e.style.background="rgba(0,0,0,0.7)",e.style.zIndex=1e3,e.style.padding="24px",e.style.overflow="auto",e.style.font="16px sans-serif";const t=document.createElement("div");t.id="skillTreePanel",t.style.maxWidth="1000px",t.style.margin="0 auto",t.style.background="#14161a",t.style.border="2px solid #6cf",t.style.borderRadius="12px",t.style.padding="16px";const o=document.createElement("div");o.style.display="flex",o.style.justifyContent="space-between",o.style.alignItems="center";const n=document.createElement("h2");n.textContent="Skill Tree",n.style.color="#fff",n.style.margin="0 0 8px 0";const l=document.createElement("div");l.id="skillPointsLabel",l.style.color="#d6f266",l.textContent="Points: 0",o.appendChild(n),o.appendChild(l);const a=document.createElement("div");a.id="skillGrid",a.style.display="flex",a.style.flexDirection="row",a.style.gap="24px",a.style.justifyContent="space-around";const i=document.createElement("div");i.style.display="flex",i.style.justifyContent="flex-end",i.style.marginTop="12px";const r=document.createElement("button");r.textContent="Close (L)",r.onclick=_,K(r),i.appendChild(r),t.appendChild(o),t.appendChild(a),t.appendChild(i),e.appendChild(t),document.body.appendChild(e)}}function K(e){e.style.padding="8px 10px",e.style.borderRadius="8px",e.style.border="1px solid #6cf",e.style.background="#0e1116",e.style.color="#fff",e.style.cursor="pointer"}function N(){const e=document.getElementById("skillGrid"),t=document.getElementById("skillPointsLabel");if(!e||!t||!w)return;e.innerHTML="",t.textContent=`Points: ${w.skillPoints||0}`,e.style.position="relative";const o={left:[],middle:[],right:[]},n={};if(Array.isArray(r.root)&&r.root.length>0&&o.middle.push(r.root[0]),r.nodes&&"object"==typeof r.nodes)for(const e in r.nodes){const t=r.nodes[e];Array.isArray(t)&&t.forEach(e=>{if(!e||!e.id)return;const t=e.branch&&o[e.branch]?e.branch:"middle";null==e.level&&(e.level=0),null==e.maxLevel&&(e.id.startsWith("uber_")?e.maxLevel=3:e.id.startsWith("ultimate_")?e.maxLevel=1:e.maxLevel=5),o[t].push(e)})}let l=document.getElementById("skillTreeSVG");l||(l=document.createElementNS("http://www.w3.org/2000/svg","svg"),l.id="skillTreeSVG",l.style.position="absolute",l.style.top="0",l.style.left="0",l.style.width="100%",l.style.height="100%",l.style.pointerEvents="none",e.appendChild(l)),l.innerHTML="";["left","middle","right"].forEach(t=>{const l=document.createElement("div");l.style.display="flex",l.style.flexDirection="column",l.style.alignItems="center",l.style.flex="1",l.style.gap="16px";o[t].forEach((e,t)=>{if(!e||!e.id)return;const o=document.createElement("div");o.style.border="1px solid #2d3947",o.style.borderRadius="10px",o.style.padding="10px",o.style.background="#0e1116",o.style.textAlign="center",o.style.width="200px";let a=e.level<e.maxLevel&&w.skillPoints>0;if(e.requires){const t=V(e.requires);t&&0!==t.level||(a=!1)}a||(o.style.opacity="0.4");const i=document.createElement("div");i.textContent=e.name||e.id,i.style.fontWeight="bold",i.style.color=1===e.maxLevel?"#ff66ff":3===e.maxLevel?"#ff4444":"#ffff66";const r=document.createElement("div");r.textContent=`Level: ${e.level}/${e.maxLevel}`,r.style.color="#d6f266",r.style.margin="4px 0";const s=document.createElement("div");s.textContent=e.desc||"",s.style.color="#b8c0cc",s.style.margin="6px 0";const c=document.createElement("button");c.textContent=e.level>=e.maxLevel?"Maxed":"Upgrade",K(c),c.disabled=!a,c.onclick=()=>{let t=e.level<e.maxLevel&&w.skillPoints>0;if(e.requires){const o=V(e.requires);o&&0!==o.level||(t=!1)}t&&(e.level++,w.skillPoints--,"function"==typeof e.apply&&e.apply(w,e.level),N(),oe())},o.appendChild(i),o.appendChild(r),o.appendChild(s),o.appendChild(c),l.appendChild(o),n[e.id]={x:0,y:0,card:o}}),e.appendChild(l)});Object.values(n).forEach(t=>{const o=t.card.getBoundingClientRect(),n=e.getBoundingClientRect();t.x=o.left-n.left+o.width/2,t.y=o.top-n.top+o.height/2});for(const e in r.nodes){const t=r.nodes[e];if(!Array.isArray(t))continue;const o=n[e];o&&t.forEach(e=>{const t=n[e.id];if(!t)return;const a=V(e.id)?.requires;let i=!0;if(a){const e=V(a);e&&0!==e.level||(i=!1)}const r=document.createElementNS("http://www.w3.org/2000/svg","line");r.setAttribute("x1",o.x),r.setAttribute("y1",o.y+60),r.setAttribute("x2",t.x),r.setAttribute("y2",t.y-60),r.setAttribute("stroke",i?"#6cf":"#666"),r.setAttribute("stroke-width","2"),l.appendChild(r)})}}function V(e){let t=r.root.find(t=>t.id===e);if(t)return t;for(const o in r.nodes)if(t=r.nodes[o].find(t=>t.id===e),t)return t;return null}function Y(){if(!w)return;X(),N();document.getElementById("skillTreeUI").style.display="block",G=!0,$=!0,B=!0}function _(){const e=document.getElementById("skillTreeUI");e&&(e.style.display="none"),G=!1,$=!1,B=!1}function J(){B=!0,$=!0;const t=document.getElementById("characterSelect");t.style.display="block",t.innerHTML="";const n=document.createElement("canvas");n.width=64,n.height=64,n.style.border="2px solid #fff",n.style.marginBottom="10px",t.appendChild(n);const l=n.getContext("2d"),a=new Image;function i(e){const t=12*e+3,o=a.naturalWidth/32||32,i=t%o*32,r=32*Math.floor(t/o);l.clearRect(0,0,n.width,n.height),a.complete&&l.drawImage(a,i,r,32,32,0,0,n.width,n.height)}a.src="assets/player.png",a.onload=()=>i(z);const r=document.createElement("label");r.textContent="Select Sprite Slot: ";const d=document.createElement("select");d.id="spriteSlotSelect";for(let e=0;e<32;e++){const t=document.createElement("option");t.value=e,t.textContent=`Slot ${e}`,d.appendChild(t)}d.addEventListener("change",()=>{z=parseInt(d.value),i(z)}),t.appendChild(r),t.appendChild(d),t.appendChild(document.createElement("br")),[{type:"warrior",name:"Warrior",desc:"High HP & damage"},{type:"archer",name:"Archer",desc:"Fires spread projectiles"},{type:"mage",name:"Mage",desc:"Fires homing projectiles"}].forEach(n=>{const l=document.createElement("button");l.textContent=`${n.name} - ${n.desc}`,l.onclick=()=>function(t){const[n,l]=function(t,o){if(!e)return[t,o];if(e.isWalkable(t,o))return[t,o];for(let n=1;n<=10;n++)for(let l=-n;l<=n;l++)for(let a=-n;a<=n;a++){const n=t+l,i=o+a;if(e.isWalkable(n,i))return[n,i]}return[t,o]}(11,10);w=new o(t,z),w.reset(n,l),s(),c(w),document.getElementById("characterSelect").style.display="none",B=!1,$=!1,x=[],T=[],S=[],P=[],D=0,H=180,I=1,j=0,R=!1,g&&cancelAnimationFrame(g);g=requestAnimationFrame(te)}(n.type),t.appendChild(l)});const p=document.createElement("div");p.style.marginTop="20px",p.style.color="#fff",p.style.font="16px sans-serif",p.innerHTML="\n    <h3>Controls</h3>\n    <p>WASD / Arrow Keys - Move</p>\n    <p>Space / Tap Attack - Fire</p>\n    <p>K - Open Shop</p>\n    <p>L - Skill Tree</p>\n    <p>Shift - Blink - Unlockable</p>\n    <p>Esc - Pause</p>\n  ",t.appendChild(p)}e.rainDrops=[],e.rainEnabled=!0,e.updateRain=function(e,t){if(!this.rainEnabled)return;this.rainDrops||(this.rainDrops=[]);for(let t=0;t<3;t++)this.rainDrops.push({x:Math.random()*e,y:-5,length:8+4*Math.random(),speed:4+4*Math.random(),alpha:.2+.3*Math.random()});for(let e=this.rainDrops.length-1;e>=0;e--){const o=this.rainDrops[e];o.y+=o.speed,o.x+=.5*Math.sin(j/10+o.y/20),o.y>t&&this.rainDrops.splice(e,1)}},e.drawRain=function(e){if(this.rainEnabled&&this.rainDrops){e.save(),e.strokeStyle="rgba(100,100,255,0.4)",e.lineWidth=1,e.beginPath();for(const t of this.rainDrops)e.moveTo(t.x,t.y),e.lineTo(t.x+.3*t.length,t.y+t.length);e.stroke(),e.restore()}},window.addEventListener("keydown",o=>{if("Escape"!==o.key||$||(B=!B),$||(C[o.key]=!0),"l"===o.key.toLowerCase()&&(G?_():Q||R||Y()),"Shift"===o.key&&w&&w.unlockedSkills.includes("blink")&&(!w.blinkCooldownTimer||w.blinkCooldownTimer<=0)){const o=w.px,n=w.py,l=w.blinkDistance||150,a=E.x/W.zoom+W.x-(w.px+t/2),i=E.y/W.zoom+W.y-(w.py+t/2),r=Math.hypot(a,i),s=r>l?l/r:1;w.px+=a*s,w.py+=i*s,w.px=Math.max(0,Math.min(w.px,e.width*t-t)),w.py=Math.max(0,Math.min(w.py,e.height*t-t)),"function"==typeof w.createBlinkTrail&&w.createBlinkTrail(o,n,w.px,w.py),w.blinkCooldownTimer=w.blinkCooldown||180}}),window.giveGold=(e=1e6)=>{w?(w.gold+=e,console.log(`Gave player ${e} gold! Total: ${w.gold}`),"function"==typeof updateGoldUI&&updateGoldUI()):console.warn("Player not defined yet.")},window.setMaxHP=(e=9999999)=>{w?(w.hp=e,w.maxHp=e,console.log(`Player HP set to ${e}`),"function"==typeof updateHpUI&&updateHpUI()):console.warn("Player not defined yet.")},window.setLevel=(e=40)=>{w?(w.level=e,console.log(`Player level set to ${e}`),w.exp=0,"function"==typeof updateLevelUI&&updateLevelUI()):console.warn("Player not defined yet.")};let Q=!1;const Z=[{name:"1) XP Boost",cost:70,action:()=>w.gainXp(10,ee)},{name:"2) Spread Projectile",cost:100,action:()=>w.unlockProjectile("spread")},{name:"3) Homing Projectile",cost:150,action:()=>w.unlockProjectile("homing")},{name:"4) Heavy Projectile",cost:150,action:()=>w.unlockProjectile("heavy")},{name:"5) Speed Boost",cost:12e3,action:()=>{w.speed+=1}},{name:"6) Exploding Projectiles",cost:250,action:()=>{w.projectileExplosion=!0}},{name:"7) Life Leech",cost:3e4,action:()=>{w.lifeLeech=.2}},{name:"8) Critical Boost",cost:18e3,action:()=>{w.critChance=Math.min((w.critChance||0)+.1,1),w.critMultiplier=(w.critMultiplier||1.5)+.5}},{name:"9) Max Range Increase",cost:150,action:()=>{w.maxDistance+=100}}];function ee(){w&&(w.skillPoints=(w.skillPoints||0)+1,Y())}function te(){!function(){if(B||R)return;w.blinkCooldownTimer>0&&w.blinkCooldownTimer--;j++,e.updateAnimation(),j%300==0&&(I+=.5,H=Math.max(40,H-2));!$&&w.hp>0&&w.update(T,x);D++,D>=H&&(D=0,function(){if(!w)return;for(let o=0;o<8;o++){const o=Math.floor(4*Math.random());let n,r;if(0===o?(n=0,r=Math.floor(Math.random()*(u/t))):1===o?(n=Math.floor(y/t)-1,r=Math.floor(Math.random()*(u/t))):2===o?(r=0,n=Math.floor(Math.random()*(y/t))):(r=Math.floor(u/t)-1,n=Math.floor(Math.random()*(y/t))),!e.isWalkable(n,r))continue;if(Math.abs(n-w.x)+Math.abs(r-w.y)<5)continue;if(w.level>=40&&Math.random()<.02&&!x.some(e=>"lateBoss"===e.type)){const e=new l(n,r,15,"lateBoss");return e.maxHp=1e3+50*I,e.hp=e.maxHp,e.touchDamage=25+5*I,e.speed=1.5,e.specialAttackCooldown=180,e.entryDelay=60,e.isLateBoss=!0,void x.push(e)}if(Math.random()<.02&&!x.some(e=>"boss"===e.type)){const e=["mega","storm","berserk"],t=e[Math.floor(Math.random()*e.length)],o=18;return void x.push(i(n,r,t,!1,o))}if(Math.random()<.04){const e=["classic","rain","tracking"],t=e[Math.floor(Math.random()*e.length)],o=20;return void x.push(a(n,r,t,o))}let s="normal",c=0;const d=Math.random();d<.1?(s="brute",c=5):d<.2?(s="shooter",c=8):d<.3?(s="fast",c=50):d<.4?(s="tank",c=4):d<.5?(s="spitter",c=10):d<.6?(s="bossling",c=6):d<.7?(s="assassin",c=7):d<.8?(s="wizard",c=25):d<.9?(s="golem",c=3):(s="archer",c=21);const p=new l(n,r,c,s);switch(s){case"assassin":p.aiType="ambusher";break;case"shooter":p.aiType="ranged-kiter";break;default:p.aiType=s}switch(s){case"brute":p.maxHp=120+30*I,p.hp=p.maxHp,p.touchDamage=12+3*I,p.speed=.8;break;case"shooter":p.maxHp=80+25*I,p.hp=p.maxHp,p.touchDamage=6+2*I,p.speed=.9,p.projectileSpeed=3,p.fireCooldownMax=120,p.fireCooldown=0,p.fireProjectile=!0;break;case"fast":p.maxHp=40+10*I,p.hp=p.maxHp,p.touchDamage=4+I,p.speed=1.8;break;case"tank":p.maxHp=150+50*I,p.hp=p.maxHp,p.touchDamage=10+2*I,p.speed=.6;break;case"spitter":p.maxHp=60+20*I,p.hp=p.maxHp,p.touchDamage=3+I,p.speed=1,p.projectileSpeed=2.5,p.fireCooldownMax=90,p.fireCooldown=0,p.fireProjectile=!0;break;case"bossling":p.maxHp=200+50*I,p.hp=p.maxHp,p.touchDamage=15+4*I,p.speed=1,p.projectileSpeed=3,p.fireCooldownMax=100,p.fireCooldown=0,p.fireProjectile=!0;break;case"assassin":p.maxHp=50+15*I,p.hp=p.maxHp,p.touchDamage=8+2*I,p.speed=2;break;case"wizard":p.maxHp=40+10*I,p.hp=p.maxHp,p.touchDamage=6+2*I,p.speed=1.2,p.projectileSpeed=3.5,p.fireCooldownMax=90,p.fireCooldown=0,p.fireProjectile=!0;break;case"golem":p.maxHp=180+60*I,p.hp=p.maxHp,p.touchDamage=14+4*I,p.speed=.5;break;case"archer":p.maxHp=70+20*I,p.hp=p.maxHp,p.touchDamage=5+1.5*I,p.speed=1,p.projectileSpeed=2.8,p.fireCooldownMax=100,p.fireCooldown=0,p.fireProjectile=!0;break;default:p.maxHp=50+15*I,p.hp=p.maxHp,p.touchDamage=5+1.5*I,p.speed=1}return p.entryDelay=30,void x.push(p)}}());for(let o=x.length-1;o>=0;o--){const l=x[o];if(l.entryDelay>0){l.entryDelay--;continue}l.update(w,j,T),e.applyTileEffects(l,Math.floor(l.px/t),Math.floor(l.py/t));if(["shooter","spitter","wizard","archer","bossling"].includes(l.type)&&l.fireCooldown<=0){const e=w.px+t/2-(l.px+t/2),o=w.py+t/2-(l.py+t/2),a=Math.hypot(e,o),i=l.projectileSpeed||3,r=e/a*i,s=o/a*i;let c="normal",d=150;switch(l.type){case"spitter":c="bouncing",d=120;break;case"wizard":c="homing",d=180;break;case"archer":c="spread",d=200;break;case"bossling":c="heavy",d=250}T.push(new n(l.px+t/2,l.py+t/2,r,s,.8*l.touchDamage,60,1,c,d)),l.fireCooldown=l.fireCooldownMax}if(l.hp<=0){const e=l.isMiniBoss?Math.floor(50+5*I):Math.floor(5+2*I),n=l.isMiniBoss?10+Math.floor(I/2):1+Math.floor(I/2),a=8,i=2+Math.floor(3*Math.random());for(let e=0;e<i;e++){const e=l.px+(Math.random()-.5)*t,o=l.py+(Math.random()-.5)*t,n=Math.floor(Math.random()*a);U.push({x:e,y:o,life:30+Math.floor(30*Math.random()),frame:n,frameTimer:0,frameSpeed:4+Math.floor(3*Math.random())})}Math.random()<.15?S.push({x:l.px+t/2,y:l.py+t/2,r:6,value:3*n,mega:!0}):S.push({x:l.px+t/2,y:l.py+t/2,r:4,value:n,mega:!1}),w.gold+=e,x.splice(o,1)}}for(let e=T.length-1;e>=0;e--){const o=T[e];if(!(o instanceof n)){T.splice(e,1);continue}o.update(x);const l=o.x-(o.startX??o.x),a=o.y-(o.startY??o.y);if(o.maxDistance&&Math.hypot(l,a)>=o.maxDistance)T.splice(e,1);else{if(o.owner===w)for(let e=x.length-1;e>=0;e--){const n=x[e];if(ne(o.x,o.y,o.radius,n.px,n.py,t,t)){let e=1.5*o.damage;const l=Math.random()<(w.critChance||0);if(l&&(e*=2),n.hp-=e,"function"==typeof w.healFromDamage&&w.healFromDamage(e),P.push({x:n.px+t/2,y:n.py,value:Math.floor(e),life:30,color:l?"#ff0":"#fff",font:l?"bold 18px sans-serif":"16px sans-serif",crit:l}),n.flashTimer=5,w.projectileExplosion){const l=60;L.push({x:o.x,y:o.y,radius:l,life:20,maxLife:20});for(const a of x){if(a===n)continue;if(Math.hypot(a.px+t/2-o.x,a.py+t/2-o.y)<=l){const o=Math.floor(.5*e);a.hp-=o,"function"==typeof w.healFromDamage&&w.healFromDamage(o),P.push({x:a.px+t/2,y:a.py,value:o,life:20,color:"#f66",font:"14px sans-serif"}),a.flashTimer=5}}}if(o.pierce--,o.pierce<=0)break}}else if(o.owner!==w&&ne(o.x,o.y,o.radius,w.px,w.py,t,t)){"function"==typeof w.takeDamage&&w.takeDamage(o.damage),T.splice(e,1);continue}(o.life<=0||o.pierce<=0)&&T.splice(e,1)}}for(let e=S.length-1;e>=0;e--){const o=S[e],n=w.px+t/2-o.x,l=w.py+t/2-o.y,a=Math.hypot(n,l);a<w.pickupRange&&(o.x+=n/Math.max(a,1)*3,o.y+=l/Math.max(a,1)*3),a<8&&(w.gainXp(o.value,ee),w.gold+=o.value,S.splice(e,1))}for(let e=P.length-1;e>=0;e--){const t=P[e];t.y-=.5,t.life--,t.life<=0&&P.splice(e,1)}for(let e=L.length-1;e>=0;e--){const t=L[e];t.life--,t.life<=0&&L.splice(e,1)}for(let e=U.length-1;e>=0;e--){const t=U[e];t.life--,t.life<=0?U.splice(e,1):(t.frameTimer++,t.frameTimer>=t.frameSpeed&&(t.frame=(t.frame+1)%8,t.frameTimer=8))}if(w.hp<=0&&!R){R=!0,A={level:w.level,gold:w.gold,time:Math.floor(j/60)};const e=document.getElementById("deathOverlay");e.innerHTML=`\n      <h2>You Died</h2>\n      <p>Level: ${A.level}</p>\n      <p>Gold: ${A.gold}</p>\n      <p>Time: ${A.time}s</p>\n      <p><a href="https://mirageonlineclassic.com" target="_blank">Mirage Online Classic - Visit the pixel MMORPG!</a></p>\n      <button id="restartBtn">Restart</button>\n    `,e.style.display="block",document.getElementById("restartBtn").onclick=()=>{e.style.display="none",J()}}w&&(W.x=w.px+t/2-y/(2*W.zoom),W.y=w.py+t/2-u/(2*W.zoom),W.x=Math.max(0,Math.min(W.x,e.width*t-y/W.zoom)),W.y=Math.max(0,Math.min(W.y,e.height*t-u/W.zoom)));oe(),e.updateRain(y,u)}(),function(){h.clearRect(0,0,y,u);let o=0,l=0;if(w.contactIFrames>0){const e=w.contactIFrames/30,t=6;o=(Math.random()-.5)*t*e,l=(Math.random()-.5)*t*e}h.save(),h.translate(o,l),h.scale(W.zoom,W.zoom),h.translate(-W.x,-W.y),e.draw(h),e.drawRain(h),h.save();for(const e of U){const o=e.frame*O,n=0;h.drawImage(q,o,n,O,O,e.x,e.y,t,t)}h.restore(),h.save();for(const e of S)h.beginPath(),h.arc(e.x,e.y,e.r,0,2*Math.PI),e.mega?h.fillStyle="#ff0":h.fillStyle="#3cf",h.fill();h.restore(),x.forEach(e=>{e.isMiniBoss&&Array.isArray(e.rainTelegraph)&&e.rainTelegraph.length>0&&(h.save(),h.fillStyle="rgba(0, 255, 255, 0.4)",e.rainTelegraph.forEach(e=>{h.beginPath(),h.arc(e.x,e.y,6,0,2*Math.PI),h.fill()}),h.restore()),e.draw(h)}),w&&w.draw(h);h.save();for(const e of P)h.fillStyle=e.color||"#fff",h.font=e.font||"16px sans-serif",h.textAlign="center",h.fillText(e.value,e.x,e.y),e.crit&&(h.fillStyle="#ff0",h.font="bold 14px sans-serif",h.fillText("Crit!",e.x,e.y-16)),e.x+=e.dx||0,e.y+=e.dy||0;h.restore(),h.save();for(const e of L){const t=e.life/e.maxLife;h.beginPath(),h.arc(e.x,e.y,e.radius*(1-.5*t),0,2*Math.PI),h.fillStyle=`rgba(255, 100, 0, ${.4*t})`,h.fill(),h.strokeStyle=`rgba(255, 200, 0, ${.6*t})`,h.lineWidth=2,h.stroke()}h.restore(),h.save();for(const e of T)e instanceof n&&e.draw(h);h.restore(),h.restore(),void 0===F&&(F=0);F>0&&(h.save(),h.fillStyle=`rgba(255,0,0,${F})`,h.fillRect(0,0,y,u),h.restore(),F-=.02,F<0&&(F=0));if(R||B&&!$){if(!B)return;B&&!$&&function(){h.fillStyle="rgba(0,0,0,0.6)",h.fillRect(0,0,y,u),h.fillStyle="#fff",h.font="28px sans-serif",h.textAlign="center",h.fillText("Game Paused",y/2,u/2-40),h.font="18px sans-serif",h.fillText(`Current Run: Lv ${w.level}, Gold ${w.gold}, Time ${(j/60).toFixed(1)}s`,y/2,u/2),A&&h.fillText(`Last Run: Lv ${A.level}, Gold ${A.gold}, Time ${A.time}s`,y/2,u/2+30);h.font="16px sans-serif",h.fillText("WASD / Arrows = Move",y/2,u/2+80),h.fillText("Space = Attack",y/2,u/2+100),h.fillText("K = Shop",y/2,u/2+120),h.fillText("L = Skill Tree, <Shift> = Blink",y/2,u/2+140),h.fillText("Esc = Pause",y/2,u/2+160)}()}Q&&Q&&w&&(h.fillStyle="rgba(192,173,229,0.6)",h.fillRect(0,0,y,u),h.fillStyle="#fff",h.font="28px sans-serif",h.textAlign="center",h.fillText("Shop",y/2,80),h.font="20px sans-serif",Z.forEach((e,t)=>{const o=140+40*t;h.fillStyle=w.gold>=e.cost?"#d6f266":"#888",h.fillText(`${e.name} - ${e.cost} Gold`,y/2,o)}),h.font="16px sans-serif",h.fillStyle="#fff",h.fillText("Press 1-9 to buy item, K to close",y/2,u-40))}(),g=requestAnimationFrame(te)}function oe(){w&&(M.textContent=`HP: ${Math.ceil(w.hp)} / ${w.maxHp}`,b.textContent=`Lv ${w.level} | XP: ${w.xp} / ${w.xpToNext} | SP ${w.skillPoints||0}`,k.textContent=`Gold: ${w.gold}`,v.textContent=`DMG ${w.damage} | ROF ${(60/w.fireCooldownMax).toFixed(1)}/s | SPD ${w.speed.toFixed(1)}`)}function ne(e,t,o,n,l,a,i){const r=e-Math.max(n,Math.min(e,n+a)),s=t-Math.max(l,Math.min(t,l+i));return r*r+s*s<=o*o}window.addEventListener("keydown",e=>{if(!Q||!w)return;const t=parseInt(e.key)-1;if(t>=0&&t<Z.length){const e=Z[t];w.gold>=e.cost&&(w.gold-=e.cost,e.action(),oe(),Q=!1,B=!1,$=!1)}}),window.addEventListener("keydown",e=>{"k"===e.key.toLowerCase()&&(Q?(Q=!1,B=!1,$=!1):$||(Q=!0,B=!0,$=!0))}),window.addEventListener("load",()=>{m=document.getElementById("gameCanvas"),h=m.getContext("2d"),y=m.width,u=m.height,e.load("maps/map.json").then(()=>J()),m.addEventListener("mousemove",e=>{const t=m.getBoundingClientRect();E.x=e.clientX-t.left,E.y=e.clientY-t.top}),m.addEventListener("click",()=>{R&&J()}),X()});